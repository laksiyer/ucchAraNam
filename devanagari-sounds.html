<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Devanagari Pronunciation Tool</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body { font-family: system-ui, Arial, sans-serif; padding: 16px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    h2 { font-size: 16px; margin: 14px 0 8px; }

    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; margin: 10px 0 14px; }
    label { font-size: 14px; color:#444; }
    select { padding: 6px 8px; border-radius: 10px; border: 1px solid #ddd; background: white; }

    .pill { font-size: 13px; padding: 6px 10px; border-radius: 999px; border: 1px solid #ddd; background:#fafafa; }
    .small { font-size: 13px; color:#666; margin-top: 10px; }

    .grid { display: grid; grid-template-columns: repeat(8, minmax(54px, 1fr)); gap: 10px; max-width: 900px; }
    .grid5 { display:grid; grid-template-columns: repeat(5, minmax(54px, 1fr)); gap: 10px; max-width: 520px; }
    .line { display:flex; gap:10px; flex-wrap: wrap; max-width: 900px; }

    .letterBtn{
      font-family: "Noto Sans Devanagari","Nirmala UI","Mangal",system-ui,sans-serif;
      font-size: 26px;
      padding: 10px 0;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,.06);
      user-select:none;
    }
    .letterBtn:active { transform: scale(0.98); }

    .ctrlBtn{
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
    }

    .letterBtn.correct { background: #d4f8d4; border-color: #2f9e44; }
    .letterBtn.wrong   { background: #ffd6d6; border-color: #c92a2a; }

    /* BIG display for the combined gunita syllable */
    #gunita-display {
      font-family: "Noto Sans Devanagari","Nirmala UI","Mangal",system-ui,sans-serif;
      font-size: 64px;
      line-height: 1.05;
      padding: 14px 22px;
      border-radius: 18px;
      border: 1px solid #ddd;
      background: #fafafa;
      text-align: center;
      min-width: 140px;
    }
  </style>
</head>

<body>
  <h1>Devanagari Pronunciation Tool</h1>

  <div class="row">
    <span class="pill" id="status">Ready</span>

    <label><input type="checkbox" id="showHint" checked> Show hint</label>

    <label>
      Display:
      <select id="scheme">
        <option value="deva" selected>Devanagari</option>
        <option value="iast">IAST</option>
        <option value="hk">Harvard‚ÄìKyoto</option>
      </select>
    </label>

    <label><input type="checkbox" id="quizMode"> Quiz</label>

    <label><input type="radio" name="quizType" value="listen" checked> Listen ‚Üí Click</label>
    <label><input type="radio" name="quizType" value="reverse"> See ‚Üí Guess</label>

    <button class="ctrlBtn" id="playNext" type="button">Play / Next</button>
    <button class="ctrlBtn" id="resetScore" type="button">Reset</button>

    <span class="pill" id="qPrompt">Quiz off</span>
    <span class="pill" id="scorePill">‚úÖ 0  ‚ùå 0  üî• 0 (best 0)</span>
  </div>

  <h2>‡§∏‡•ç‡§µ‡§∞‡§æ‡§É</h2>
  <div class="grid" id="grid-vowels"></div>

  <h2>‡§µ‡§∞‡•ç‡§ó‡•Ä‡§Ø ‡§µ‡•ç‡§Ø‡§û‡•ç‡§ú‡§®‡§æ‡§®‡§ø</h2>
  <div class="grid5" id="grid-vargiya"></div>

  <h2>‡§Ö‡§µ‡§∞‡•ç‡§ó‡•Ä‡§Ø ‡§µ‡•ç‡§Ø‡§û‡•ç‡§ú‡§®‡§æ‡§®‡§ø</h2>
  <div class="line" id="line-avargiya"></div>

  <!-- GUNITA SECTION -->
  <h2>‡§ó‡•Å‡§£‡§ø‡§§ ‡§Ö‡§ï‡•ç‡§∑‡§∞‡§æ‡§£‡§ø <span class="small">(Work in progress)</span></h2>
  <div class="row">
    <span class="pill">1) Pick a consonant  ‚Üí  2) Pick a vowel/mƒÅtrƒÅ</span>
    <span class="pill" id="gunita-status">Selected: ‚Äî</span>
  </div>
  <div class="line" id="gunita-consonants"></div>
  <div class="line" id="gunita-matras"></div>
  <div class="row">
    <div id="gunita-display">‚Äî</div>
  </div>

  <p class="small">Developed by Samskritabharati USA</p>

  <script>
    const AUDIO_BASE_URL = "https://laksiyer.github.io/ucchAraNam/audio/";

    // HK conventions:
    // ƒÅ A, ƒ´ I, ≈´ U, ·πõ R, ·πù RR, ·∏∑ L, ·πÖ G, √± J, ·π≠ T, ·∏ç D, ·πá N, ≈õ z, ·π£ S, ·πÉ M, ·∏• H
    const vowels = [
      { key:"a",  deva:"‡§Ö",  iast:"a",   hk:"a",  hint:"a",   file:"a.mp3" },
      { key:"aa", deva:"‡§Ü",  iast:"ƒÅ",   hk:"A",  hint:"ƒÅ",   file:"aa.mp3" },
      { key:"i",  deva:"‡§á",  iast:"i",   hk:"i",  hint:"i",   file:"i.mp3" },
      { key:"ii", deva:"‡§à",  iast:"ƒ´",   hk:"I",  hint:"ƒ´",   file:"ii.mp3" },
      { key:"u",  deva:"‡§â",  iast:"u",   hk:"u",  hint:"u",   file:"u.mp3" },
      { key:"uu", deva:"‡§ä",  iast:"≈´",   hk:"U",  hint:"≈´",   file:"uu.mp3" },
      { key:"ri", deva:"‡§ã",  iast:"·πõ",   hk:"R",  hint:"·πõ",   file:"ri.mp3" },
      { key:"rri",deva:"‡•†",  iast:"·πù",   hk:"RR", hint:"·πù",   file:"rri.mp3" },
      { key:"lr", deva:"‡§å",  iast:"·∏∑",   hk:"L",  hint:"·∏∑",   file:"lr.mp3" },
      { key:"e",  deva:"‡§è",  iast:"e",   hk:"e",  hint:"e",   file:"e.mp3" },
      { key:"ai", deva:"‡§ê",  iast:"ai",  hk:"ai", hint:"ai",  file:"ai.mp3" },
      { key:"o",  deva:"‡§ì",  iast:"o",   hk:"o",  hint:"o",   file:"o.mp3" },
      { key:"au", deva:"‡§î",  iast:"au",  hk:"au", hint:"au",  file:"au.mp3" },
      { key:"am", deva:"‡§Ö‡§Ç", iast:"a·πÉ",  hk:"aM", hint:"a·πÉ",  file:"am.mp3" },
      { key:"ah", deva:"‡§Ö‡§É", iast:"a·∏•",  hk:"aH", hint:"a·∏•",  file:"ah.mp3" }
    ];

    const vargiya = [
      { key:"ka",  deva:"‡§ï", iast:"ka",  hk:"ka",  hint:"ka",  file:"ka.mp3" },
      { key:"kha", deva:"‡§ñ", iast:"kha", hk:"kha", hint:"kha", file:"kha.mp3" },
      { key:"ga",  deva:"‡§ó", iast:"ga",  hk:"ga",  hint:"ga",  file:"ga.mp3" },
      { key:"gha", deva:"‡§ò", iast:"gha", hk:"gha", hint:"gha", file:"gha.mp3" },
      { key:"nga", deva:"‡§ô", iast:"·πÖa",  hk:"Ga",  hint:"·πÖa",  file:"nga.mp3" },

      { key:"ca",  deva:"‡§ö", iast:"ca",  hk:"ca",  hint:"ca",  file:"ca.mp3" },
      { key:"cha", deva:"‡§õ", iast:"cha", hk:"cha", hint:"cha", file:"cha.mp3" },
      { key:"ja",  deva:"‡§ú", iast:"ja",  hk:"ja",  hint:"ja",  file:"ja.mp3" },
      { key:"jha", deva:"‡§ù", iast:"jha", hk:"jha", hint:"jha", file:"jha.mp3" },
      { key:"nya", deva:"‡§û", iast:"√±a",  hk:"Ja",  hint:"√±a",  file:"nya.mp3" },

      { key:"tta",  deva:"‡§ü", iast:"·π≠a",  hk:"Ta",  hint:"·π≠a",  file:"ta_retro.mp3" },
      { key:"ttha", deva:"‡§†", iast:"·π≠ha", hk:"Tha", hint:"·π≠ha", file:"tha_retro.mp3" },
      { key:"dda",  deva:"‡§°", iast:"·∏ça",  hk:"Da",  hint:"·∏ça",  file:"da_retro.mp3" },
      { key:"ddha", deva:"‡§¢", iast:"·∏çha", hk:"Dha", hint:"·∏çha", file:"dha_retro.mp3" },
      { key:"nna",  deva:"‡§£", iast:"·πáa",  hk:"Na",  hint:"·πáa",  file:"na_retro.mp3" },

      { key:"ta",  deva:"‡§§", iast:"ta",  hk:"ta",  hint:"ta",  file:"ta.mp3" },
      { key:"tha", deva:"‡§•", iast:"tha", hk:"tha", hint:"tha", file:"tha.mp3" },
      { key:"da",  deva:"‡§¶", iast:"da",  hk:"da",  hint:"da",  file:"da.mp3" },
      { key:"dha", deva:"‡§ß", iast:"dha", hk:"dha", hint:"dha", file:"dha.mp3" },
      { key:"na",  deva:"‡§®", iast:"na",  hk:"na",  hint:"na",  file:"na.mp3" },

      { key:"pa",  deva:"‡§™", iast:"pa",  hk:"pa",  hint:"pa",  file:"pa.mp3" },
      { key:"pha", deva:"‡§´", iast:"pha", hk:"pha", hint:"pha", file:"pha.mp3" },
      { key:"ba",  deva:"‡§¨", iast:"ba",  hk:"ba",  hint:"ba",  file:"ba.mp3" },
      { key:"bha", deva:"‡§≠", iast:"bha", hk:"bha", hint:"bha", file:"bha.mp3" },
      { key:"ma",  deva:"‡§Æ", iast:"ma",  hk:"ma",  hint:"ma",  file:"ma.mp3" }
    ];

    const avargiya = [
      { key:"ya", deva:"‡§Ø", iast:"ya", hk:"ya", hint:"ya", file:"ya.mp3" },
      { key:"ra", deva:"‡§∞", iast:"ra", hk:"ra", hint:"ra", file:"ra.mp3" },
      { key:"la", deva:"‡§≤", iast:"la", hk:"la", hint:"la", file:"la.mp3" },
      { key:"va", deva:"‡§µ", iast:"va", hk:"va", hint:"va", file:"va.mp3" },
      { key:"sha",deva:"‡§∂", iast:"≈õa", hk:"za", hint:"≈õa", file:"sha_palatal.mp3" },
      { key:"ssa",deva:"‡§∑", iast:"·π£a", hk:"Sa", hint:"·π£a", file:"sha_retro.mp3" },
      { key:"sa", deva:"‡§∏", iast:"sa", hk:"sa", hint:"sa", file:"sa.mp3" },
      { key:"ha", deva:"‡§π", iast:"ha", hk:"ha", hint:"ha", file:"ha.mp3" }
    ];

    // Matras for gunita (NO ‡•° / ‡•£)
    const matras = [
      { key:"a",   deva:"",  vowelFile:"a.mp3"   }, // inherent vowel (show as "‡§Ö")
      { key:"aa",  deva:"‡§æ", vowelFile:"aa.mp3"  },
      { key:"i",   deva:"‡§ø", vowelFile:"i.mp3"   },
      { key:"ii",  deva:"‡•Ä", vowelFile:"ii.mp3"  },
      { key:"u",   deva:"‡•Å", vowelFile:"u.mp3"   },
      { key:"uu",  deva:"‡•Ç", vowelFile:"uu.mp3"  },
      { key:"ri",  deva:"‡•É", vowelFile:"ri.mp3"  },
      { key:"rri", deva:"‡•Ñ", vowelFile:"rri.mp3" },
      { key:"lr",  deva:"‡•¢", vowelFile:"lr.mp3"  },
      { key:"e",   deva:"‡•á", vowelFile:"e.mp3"   },
      { key:"ai",  deva:"‡•à", vowelFile:"ai.mp3"  },
      { key:"o",   deva:"‡•ã", vowelFile:"o.mp3"   },
      { key:"au",  deva:"‡•å", vowelFile:"au.mp3"  },
      { key:"am",  deva:"‡§Ç", vowelFile:"am.mp3"  },
      { key:"ah",  deva:"‡§É", vowelFile:"ah.mp3"  }
    ];

    const allItems = [...vowels, ...vargiya, ...avargiya];
    const byKey = new Map(allItems.map(x => [x.key, x]));
    const quizPool = [...vargiya, ...avargiya]; // questions come from here

    // --- UI ---
    const status = document.getElementById("status");
    const showHint = document.getElementById("showHint");
    const schemeSel = document.getElementById("scheme");
    const quizMode = document.getElementById("quizMode");
    const playNext = document.getElementById("playNext");
    const qPrompt = document.getElementById("qPrompt");
    const scorePill = document.getElementById("scorePill");
    const resetScoreBtn = document.getElementById("resetScore");
    const quizTypeRadios = document.querySelectorAll('input[name="quizType"]');

    // Gunita UI
    const gunitaStatus = document.getElementById("gunita-status");
    const gunitaDisplay = document.getElementById("gunita-display");

    // --- State ---
    let scheme = schemeSel.value; // deva|iast|hk
    let quizType = "listen";      // listen|reverse
    let quizAnswerKey = null;

    // scoring (per QUESTION, not per click)
    let correctCount = 0;
    let incorrectCount = 0;
    let streak = 0;
    let bestStreak = 0;
    let missedThisQuestion = false;

    // Gunita selection
    let selectedConsonant = null;

    // --- Audio ---
    const player = new Audio();
    player.preload = "auto";

    function labelOf(x) { return (x && x[scheme]) ? x[scheme] : (x.deva || ""); }
    function setStatus(msg) { status.textContent = msg; }

    function playFile(file, msg) {
      try { player.pause(); player.currentTime = 0; } catch(e) {}
      const url = AUDIO_BASE_URL + file;
      setStatus(msg);
      player.src = url;
      player.play().catch(() => alert("Could not play: " + url));
    }

    // play multiple audio clips in order (for gunita)
    async function playSequence(files) {
      for (const f of files) {
        await new Promise((resolve, reject) => {
          try { player.pause(); player.currentTime = 0; } catch(e) {}
          player.src = AUDIO_BASE_URL + f;
          player.onended = resolve;
          player.onerror = reject;
          player.play().catch(reject);
        });
      }
    }

    function clearFeedback() {
      document.querySelectorAll(".letterBtn").forEach(b => b.classList.remove("correct","wrong"));
    }

    function updateScoreUI() {
      scorePill.textContent = `‚úÖ ${correctCount}  ‚ùå ${incorrectCount}  üî• ${streak} (best ${bestStreak})`;
    }

    function resetScore() {
      correctCount = 0;
      incorrectCount = 0;
      streak = 0;
      bestStreak = 0;
      missedThisQuestion = false;
      updateScoreUI();
      clearFeedback();
      setStatus("Ready");
      if (!quizMode.checked) qPrompt.textContent = "Quiz off";
    }

    function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    function startQuestion() {
      clearFeedback();
      const x = pick(quizPool);
      quizAnswerKey = x.key;
      missedThisQuestion = false;

      if (quizType === "listen") {
        qPrompt.textContent = "Listen ‚Üí Click";
        playFile(x.file, "Quiz sound");
      } else {
        qPrompt.textContent = "See ‚Üí Guess (then Play)";
        setStatus("Shown: " + labelOf(x));
      }
    }

    function renderButtons(containerId, items, modeLine=false) {
      const container = document.getElementById(containerId);
      items.forEach(x => {
        const b = document.createElement("button");
        b.className = "letterBtn";
        b.dataset.key = x.key;
        b.textContent = labelOf(x);
        if (modeLine) b.style.padding = "10px 14px";

        const updateTitle = () => {
          b.title = showHint.checked ? (x.hint + " (" + x.file + ")") : "";
        };
        updateTitle();
        showHint.addEventListener("change", updateTitle);

        b.onclick = () => {
          if (!quizMode.checked) {
            playFile(x.file, labelOf(x) + (showHint.checked ? " = " + x.hint : ""));
            return;
          }

          // quiz attempt
          clearFeedback();

          if (x.key === quizAnswerKey) {
            b.classList.add("correct");
            qPrompt.textContent = "‚úÖ Correct!";

            correctCount += 1;
            if (missedThisQuestion) {
              incorrectCount += 1;
              streak = 0;
            } else {
              streak += 1;
              if (streak > bestStreak) bestStreak = streak;
            }
            updateScoreUI();

            playFile(x.file, "Correct");
            setTimeout(startQuestion, 800);

          } else {
            b.classList.add("wrong");
            qPrompt.textContent = "‚ùå Try again";
            missedThisQuestion = true;

            if (quizType === "listen" && quizAnswerKey) {
              const target = byKey.get(quizAnswerKey);
              if (target) setTimeout(() => playFile(target.file, "Try again"), 200);
            }
          }
        };

        container.appendChild(b);
      });
    }

    // Render gunita controls
    function renderGunita() {
      const cDiv = document.getElementById("gunita-consonants");
      const mDiv = document.getElementById("gunita-matras");

      const consonants = [...vargiya, ...avargiya];

      consonants.forEach(c => {
        const b = document.createElement("button");
        b.className = "letterBtn";
        b.textContent = c.deva;
        b.title = "Select consonant: " + c.deva;
        b.onclick = () => {
          selectedConsonant = c;
          gunitaStatus.textContent = "Selected: " + c.deva;
          gunitaDisplay.textContent = c.deva; // default
          playFile(c.file, "Selected: " + c.deva);
        };
        cDiv.appendChild(b);
      });

      matras.forEach(m => {
        const b = document.createElement("button");
        b.className = "letterBtn";
        b.textContent = m.deva || "‡§Ö";
        b.title = "Apply: " + (m.deva || "‡§Ö");

        b.onclick = async () => {
          if (!selectedConsonant) {
            alert("First select a consonant (e.g., ‡§ï).");
            return;
          }

          const combined = selectedConsonant.deva + (m.deva || "");
          gunitaDisplay.textContent = combined;

          try {
            await playSequence([selectedConsonant.file, m.vowelFile]);
            setStatus("Playing: " + combined);
          } catch (e) {
            console.error(e);
            alert("Could not play gunita audio. Check file names:\n" +
              selectedConsonant.file + " + " + m.vowelFile);
          }
        };

        mDiv.appendChild(b);
      });
    }

    // Initial render
    renderButtons("grid-vowels", vowels);
    renderButtons("grid-vargiya", vargiya);
    renderButtons("line-avargiya", avargiya, true);

    // Gunita render
    renderGunita();

    // Scheme toggle
    schemeSel.addEventListener("change", () => {
      scheme = schemeSel.value;
      document.querySelectorAll(".letterBtn").forEach(btn => {
        const x = byKey.get(btn.dataset.key);
        if (x) btn.textContent = labelOf(x); // update only main letter buttons with data-key
      });
      if (quizMode.checked && quizType === "reverse" && quizAnswerKey) {
        const x = byKey.get(quizAnswerKey);
        setStatus("Shown: " + labelOf(x));
      }
    });

    // Quiz type toggle
    quizTypeRadios.forEach(r => r.addEventListener("change", () => {
      quizType = document.querySelector('input[name="quizType"]:checked').value;
      if (quizMode.checked) startQuestion();
    }));

    // Play/Next button
    playNext.addEventListener("click", () => {
      if (!quizMode.checked) return;

      if (quizType === "reverse" && quizAnswerKey) {
        const x = byKey.get(quizAnswerKey);
        playFile(x.file, "Reveal");
      } else {
        startQuestion();
      }
    });

    // Quiz toggle
    quizMode.addEventListener("change", () => {
      clearFeedback();
      if (quizMode.checked) {
        startQuestion();
      } else {
        quizAnswerKey = null;
        missedThisQuestion = false;
        qPrompt.textContent = "Quiz off";
        setStatus("Ready");
      }
    });

    // Reset button
    resetScoreBtn.addEventListener("click", resetScore);

    // Init score display
    updateScoreUI();
  </script>
</body>
</html>
