<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Devanagari Pronunciation Tool</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body { font-family: system-ui, Arial, sans-serif; padding: 16px; }
    h1 { font-size: 20px; margin: 0 0 10px; }
    h2 { font-size: 16px; margin: 14px 0 8px; }

    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; margin: 10px 0 14px; }
    label { font-size: 14px; color:#444; }
    select { padding: 6px 8px; border-radius: 10px; border: 1px solid #ddd; background: white; }

    .pill { font-size: 13px; padding: 6px 10px; border-radius: 999px; border: 1px solid #ddd; background:#fafafa; }
    .small { font-size: 13px; color:#666; margin-top: 10px; }

    .grid { display: grid; grid-template-columns: repeat(8, minmax(54px, 1fr)); gap: 10px; max-width: 900px; }
    .grid5 { display:grid; grid-template-columns: repeat(5, minmax(54px, 1fr)); gap: 10px; max-width: 520px; }
    .line { display:flex; gap:10px; flex-wrap: wrap; max-width: 900px; }


/* Ensure cards never clip content on small screens */
.card {
  box-sizing: border-box;
  overflow: visible;
}
@media (max-width: 600px) {
  .card {
    padding-left: 14px;
    padding-right: 14px;
  }
}
.card--wordRecog {
  max-width: 100%;
}
.card--wordRecog .row {
  flex-wrap: wrap;
}
.cardHelp {
  margin: 0 0 10px;
}
/* On phones: make quiz choices wrap as a grid */
@media (max-width: 600px) {

  /* Conjunct Recognition Quiz */
  #cqChoices {
    display: grid !important;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 10px;
  }

  /* Word Recognition (Hear/Read ‚Üí Choose) */
  #wrChoices {
    display: grid !important;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 10px;
  }

  /* Fit buttons properly */
  #cqChoices button,
  #wrChoices button {
    width: 100%;
    max-width: 100%;
  }

  /* Prevent prompt boxes from causing overflow */
  #wrPromptBox, #cqPromptBox {
    max-width: 100%;
  }
}

    .letterBtn{
      font-family: "Noto Sans Devanagari","Nirmala UI","Mangal",system-ui,sans-serif;
      font-size: 26px;
      padding: 10px 0;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,.06);
      user-select:none;
    }
    .letterBtn:active { transform: scale(0.98); }

    .ctrlBtn{
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
    }

    .letterBtn.correct { background: #d4f8d4; border-color: #2f9e44; }
    .letterBtn.wrong   { background: #ffd6d6; border-color: #c92a2a; }

    /* ---------- TOC + Back-to-top ---------- */
    .tocCard{
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px 14px;
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
      max-width: 980px;
      margin: 10px 0 18px;
    }
    .tocCard h3{ margin: 0 0 8px; font-size: 14px; }
    .tocCard ul{ margin: 0; padding-left: 18px; }
    .tocCard li{ margin: 4px 0; }
    .tocCard a{ text-decoration: none; }
    .backTop { font-size: 13px; margin: 8px 0 16px; }
    .backTop a{ text-decoration:none; }

    /* ---------- GUNITA COLOR SYSTEM (color-blind friendly) ---------- */
    #gunita-consonants .letterBtn { background: #ffffff; border-color: #cfcfcf; }
    #gunita-matras .letterBtn { background: #e7f1ff; border-color: #2b6cb0; }
    #gunita-matras .letterBtn[data-matra="a"] { background: #f3f4f6; border-color: #6b7280; }

    #gunita-display {
      font-family: "Noto Sans Devanagari","Nirmala UI","Mangal",system-ui,sans-serif;
      font-size: 64px;
      line-height: 1.05;
      padding: 16px 28px;
      border-radius: 18px;
      background: #fff7e6;
      border: 2px solid #b45309;
      color: #0f172a;
      min-width: 160px;
      text-align: center;
      position: relative;
    }
    #gunita-display::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      width: 10px;
      height: 100%;
      background: #b45309;
      border-top-left-radius: 18px;
      border-bottom-left-radius: 18px;
    }

    /* Gunita-only halanta note */
    #halantaNoteGunita { display:none; }
    #halantaNoteGunita.show { display:inline; }

    /* ---------- DRAWING QUIZ ---------- */
    .card {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px;
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
      max-width: 980px;
    }
    .quizGrid {
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 900px) {
      .quizGrid { grid-template-columns: 1.2fr 0.8fr; align-items:start; }
    }
    .drawCanvas {
      width: 100%;
      max-width: 720px;
      height: 260px;
      border: 2px solid #d1d5db;
      border-radius: 12px;
      background: #ffffff;
      touch-action: none;
      display:block;
    }
    .textboxDeva {
      font-family: "Noto Sans Devanagari","Nirmala UI","Mangal",system-ui,sans-serif;
      font-size: 30px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      width: min(420px, 100%);
    }
    .quizBig {
      font-family: "Noto Sans Devanagari","Nirmala UI","Mangal",system-ui,sans-serif;
      font-size: 48px;
      line-height: 1.1;
      padding: 10px 16px;
      border-radius: 14px;
      border: 2px solid #cbd5e1;
      background: #f8fafc;
      display:inline-block;
      min-width: 120px;
      text-align:center;
      word-break: break-word;
    }
    .okPill { background:#d4f8d4; border-color:#2f9e44; }
    .badPill { background:#ffd6d6; border-color:#c92a2a; }

     .choiceBtn { font-size: 22px; }
     .choiceBtn.correct { background: #d4f8d4; border-color: #2f9e44; }
     .choiceBtn.wrong   { background: #ffd6d6; border-color: #c92a2a; }
.formation {
  font-size: 28px;
  border: 1px dashed #ddd;
  border-radius: 12px;
  padding: 10px 12px;
  background: #fafafa;
  display: inline-block;
}
canvas { touch-action: none; }
.revealWrap { border-top: 1px solid #eee; padding-top: 10px; }
.revealWord {
  font-family: "Noto Sans Devanagari", system-ui, Arial, sans-serif;
  font-size: 56px;
  line-height: 1.15;
  padding: 14px 16px;
  border-radius: 14px;
  border: 2px solid #c9d6ff;
  background: #f6f8ff;
}
/* --- Section theming (subtle, color-blind friendly) --- */
.card {
  border: 1px solid #e6e6e6;
  border-radius: 16px;
  background: #fff;
  padding: 14px;
  box-shadow: 0 1px 2px rgba(0,0,0,.05);
  margin: 14px 0;
}

/* Accent bar on the left */
.cardAccent {
  position: relative;
  overflow: hidden;
}
.cardAccent::before {
  content: "";
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 10px;
  background: #ddd; /* overridden per section */
  opacity: 0.9;
}

/* Variants */
.card--letters { background: #fbfdff; border-color: #dbeafe; }
.card--letters.cardAccent::before { background: #2563eb; } /* blue */

.card--gunita { background: #fffdf6; border-color: #fde68a; }
.card--gunita.cardAccent::before { background: #d97706; } /* amber */

.card--gunitaQuiz { background: #f7fffb; border-color: #bbf7d0; }
.card--gunitaQuiz.cardAccent::before { background: #16a34a; } /* green */

.card--wordQuiz { background: #fbf7ff; border-color: #e9d5ff; }
.card--wordQuiz.cardAccent::before { background: #7c3aed; } /* purple */

.card--wordRecog { background: #f7fbff; border-color: #bae6fd; }
.card--wordRecog.cardAccent::before { background: #0284c7; } /* cyan-blue */

.card--conj { background: #fff7f8; border-color: #fecaca; }
.card--conj.cardAccent::before { background: #e11d48; } /* rose/red */

.card--conjQuiz { background: #f8fafc; border-color: #cbd5e1; }
.card--conjQuiz.cardAccent::before { background: #334155; } /* slate */

/* --- TOC styling --- */
.tocCard {
  background: #f8fafc;              /* very light slate */
  border: 1px solid #cbd5e1;        /* slate border */
  border-radius: 16px;
  padding: 14px 16px;
  margin: 16px 0;
  box-shadow: 0 1px 2px rgba(0,0,0,.05);
  position: relative;
}

/* Accent bar on the left (matches conjunct quiz slate) */
.tocCard::before {
  content: "";
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 10px;
  background: #334155;              /* slate accent */
  border-radius: 16px 0 0 16px;
}

/* TOC title */
.tocCard h3 {
  margin: 0 0 10px 0;
  padding-left: 10px;
  color: #334155;
  font-size: 1.1rem;
}

/* Lists */
.tocCard ul {
  list-style: none;
  padding-left: 18px;
  margin: 0;
}

.tocCard li {
  margin: 6px 0;
}

/* Nested lists (Gunita, Conjunct subsections) */
.tocCard ul ul {
  margin-top: 6px;
  padding-left: 16px;
  border-left: 2px solid #e2e8f0;
}

/* Links */
.tocCard a {
  text-decoration: none;
  color: #0f172a;                   /* slate-900 */
  font-weight: 500;
}

.tocCard a:hover {
  color: #2563eb;                   /* blue hover */
  text-decoration: underline;
}

/* Subsection links slightly lighter */
.tocCard ul ul a {
  font-weight: 400;
  color: #334155;
}
/* --- Mobile fix: keep Prompt + Choices from spilling off-screen --- */
@media (max-width: 600px) {

  /* Word Recognition quiz (gunita words: Hear/Read ‚Üí Choose) */
  .card--wordRecog .row { 
    flex-wrap: wrap;          /* allow wrapping on small screens */
  }
  .card--wordRecog #wrPromptBox {
    width: 100%;
    max-width: 100%;
  }
  .card--wordRecog #wrChoices {
    width: 100%;
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 10px;
  }
  .card--wordRecog #wrChoices button {
    width: 100%;
    max-width: 100%;
  }

  /* Conjunct Recognition quiz (Hear/Read ‚Üí Choose) */
  .card--conjQuiz .row {
    flex-wrap: wrap;
  }
  .card--conjQuiz #cqPromptBox {
    width: 100%;
    max-width: 100%;
  }
  .card--conjQuiz #cqChoices {
    width: 100%;
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 10px;
  }
  .card--conjQuiz #cqChoices button {
    width: 100%;
    max-width: 100%;
  }
}

/* extra-small phones: 1 column choices */
@media (max-width: 380px) {
  .card--wordRecog #wrChoices,
  .card--conjQuiz  #cqChoices {
    grid-template-columns: 1fr;
  }
}


 </style>
</head>

<body id="top">
  <h1>Devanagari Pronunciation Tool</h1>

<!-- TOC -->
<div class="tocCard">
  <h3>Contents</h3>
  <ul>
    <li>
      <a href="#sec-vowels">‡§∏‡•ç‡§µ‡§∞‡§æ‡§É / svarƒÅ·∏• ‚Äî Vowels</a>
    </li>

    <li>
      <a href="#sec-vargiya">‡§µ‡§∞‡•ç‡§ó‡•Ä‡§Ø-‡§µ‡•ç‡§Ø‡§û‡•ç‡§ú‡§®‡§æ‡§®‡§ø / vargƒ´ya-vya√±janƒÅni ‚Äî Varga consonants</a>
    </li>

    <li>
      <a href="#sec-avargiya">‡§Ö‡§µ‡§∞‡•ç‡§ó‡•Ä‡§Ø-‡§µ‡•ç‡§Ø‡§û‡•ç‡§ú‡§®‡§æ‡§®‡§ø / avargƒ´ya-vya√±janƒÅni ‚Äî Non-varga consonants</a>
    </li>

    <li>
      <a href="#sec-gunita">
        ‡§ó‡•Å‡§£‡§ø‡§§‡§æ‡§ï‡•ç‡§∑‡§∞‡§æ‡§£‡§ø / gu·πáitƒÅk·π£arƒÅ·πái ‚Äî Vowel-modified consonants
      </a>
      <ul>
        <li>
          <a href="#sec-gunita-quiz">
            ‡§ó‡•Å‡§£‡§ø‡§§‡§æ‡§ï‡•ç‡§∑‡§∞-‡§≤‡•á‡§ñ‡§®-‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä ‚Äî Writing practice
          </a>
        </li>
        <li>
          <a href="#sec-word-quiz">
            ‡§ó‡•Å‡§£‡§ø‡§§-‡§∂‡§¨‡•ç‡§¶-‡§≤‡•á‡§ñ‡§®-‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä ‚Äî Word writing
          </a>
        </li>
        <li>
          <a href="#sec-word-recog">
            ‡§ó‡•Å‡§£‡§ø‡§§-‡§∂‡§¨‡•ç‡§¶-‡§∂‡•ç‡§∞‡§µ‡§£-‡§™‡§†‡§®‡§æ‡§µ‡§ó‡§Æ‡§®‡§Æ‡•ç ‚Äî Hear &amp; read
          </a>
        </li>
      </ul>
    </li>

    <li>
      <a href="#sec-conj">
        ‡§∏‡§Ç‡§Ø‡•Å‡§ï‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞‡§æ‡§£‡§ø / sa·πÉyuktƒÅk·π£arƒÅ·πái ‚Äî Conjunct consonants
      </a>
      <ul>
        <li>
          <a href="#sec-conj-word-quiz">
            ‡§∏‡§Ç‡§Ø‡•Å‡§ï‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞-‡§∂‡§¨‡•ç‡§¶-‡§≤‡•á‡§ñ‡§®-‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä ‚Äî Conjunct Word Writing Quiz
          </a>
        </li>
      </ul>
    </li>
  </ul>
</div>



  <div class="row">
    <span class="pill" id="status">Ready</span>

    <label><input type="checkbox" id="showHint" checked> Show hint</label>

    <label>
      Display:
      <select id="scheme">
        <option value="deva" selected>Devanagari</option>
        <option value="iast">IAST</option>
        <option value="hk">Harvard‚ÄìKyoto</option>
      </select>
    </label>

    <label><input type="checkbox" id="quizMode"> Quiz</label>

    <label><input type="radio" name="quizType" value="listen" checked> Listen ‚Üí Click</label>
    <label><input type="radio" name="quizType" value="reverse"> See ‚Üí Guess</label>

    <button class="ctrlBtn" id="playNext" type="button">Play / Next</button>
    <button class="ctrlBtn" id="resetScore" type="button">Reset</button>

    <span class="pill" id="qPrompt">Quiz off</span>
    <span class="pill" id="scorePill">‚úÖ 0  ‚ùå 0  üî• 0 (best 0)</span>
  </div>

  <!-- VOWELS -->
  <h2 id="sec-vowels">‡§∏‡•ç‡§µ‡§∞‡§æ‡§É / svarƒÅ·∏• ‚Äî Vowels</h2>
  <div class="grid" id="grid-vowels"></div>
  <div class="backTop"><a href="#top">‚Üë Back to top</a></div>

  <!-- VARGIYA -->
  <h2 id="sec-vargiya">‡§µ‡§∞‡•ç‡§ó‡•Ä‡§Ø-‡§µ‡•ç‡§Ø‡§û‡•ç‡§ú‡§®‡§æ‡§®‡§ø / vargƒ´ya-vya√±janƒÅni ‚Äî Varga consonants</h2>
  <div class="grid5" id="grid-vargiya"></div>
  <div class="backTop"><a href="#top">‚Üë Back to top</a></div>

  <!-- AVARGIYA -->
  <h2 id="sec-avargiya">‡§Ö‡§µ‡§∞‡•ç‡§ó‡•Ä‡§Ø-‡§µ‡•ç‡§Ø‡§û‡•ç‡§ú‡§®‡§æ‡§®‡§ø / avargƒ´ya-vya√±janƒÅni ‚Äî Non-varga consonants</h2>
  <div class="line" id="line-avargiya"></div>
  <div class="backTop"><a href="#top">‚Üë Back to top</a></div>

  <!-- GUNITA SECTION -->
  <h2 id="sec-gunita">‡§ó‡•Å‡§£‡§ø‡§§‡§æ‡§ï‡•ç‡§∑‡§∞‡§æ‡§£‡§ø / gu·πáitƒÅk·π£arƒÅ·πái ‚Äî Vowel-modified consonants</h2>
  <div class="row">
    <span class="pill">1) Pick a consonant ‚Üí 2) Pick a vowel/mƒÅtrƒÅ</span>
    <span class="pill" id="gunita-status">Selected: ‚Äî</span>

    <label>
      <input type="checkbox" id="showHalantaGunita">
      Show halanta here (‡§ï‡•ç)
    </label>
    <span class="small" id="halantaNoteGunita">
      Halanta shown for recognition; audio uses normal consonant sound (‡§ï, ‡§ñ‚Ä¶).
    </span>
  </div>

  <div class="line" id="gunita-consonants"></div>
  <div class="line" id="gunita-matras"></div>
  <div class="row">
    <div id="gunita-display">‚Äî</div>
  </div>
  <div class="backTop"><a href="#top">‚Üë Back to top</a></div>

  <!-- GUNITA WRITING QUIZ (akshara) -->
  <h2 id="sec-gunita-quiz">‡§ó‡•Å‡§£‡§ø‡§§‡§æ‡§ï‡•ç‡§∑‡§∞-‡§≤‡•á‡§ñ‡§®-‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä (listen ‚Üí write)</h2>
  <div class="card cardAccent card--gunitaQuiz">
    <p class="small" style="margin: 0 0 10px;">
      <b>How to use:</b> Click <b>Next (play)</b> to hear a gu·πáitƒÅk·π£ara. Write it on the canvas <i>or</i> type it in the box.
      Click <b>Check</b> (typing is graded). Use <b>Replay</b> to hear again, <b>Clear</b> to erase, and <b>Reveal</b> to see the answer.
    </p>

    <div class="row">
      <button class="ctrlBtn" id="dqNext" type="button">Next (play)</button>
      <button class="ctrlBtn" id="dqReplay" type="button">Replay</button>
      <button class="ctrlBtn" id="dqClear" type="button">Clear</button>
      <button class="ctrlBtn" id="dqReveal" type="button">Reveal</button>
      <button class="ctrlBtn" id="dqReset" type="button">Reset score</button>

      <span class="pill" id="dqResult">Ready</span>
      <span class="pill" id="dqScore">‚úÖ 0  ‚ùå 0  üî• 0 (best 0)</span>
    </div>

    <div class="quizGrid">
      <div>
        <canvas class="drawCanvas" id="drawCanvas" width="1400" height="520"></canvas>
        <p class="small">
          Note: Browsers can‚Äôt reliably grade handwriting without ML/OCR.
          So scoring uses the typed answer; the drawing is for practice + comparison.
        </p>
      </div>

      <div>
        <div class="row" style="margin-top:0;">
          <span class="pill">Type what you wrote (Devanagari):</span>
        </div>
        <input class="textboxDeva" id="dqTyped" placeholder="‡§â‡§¶‡§æ: ‡§ï‡•á" autocomplete="off" />
        <div class="row">
          <button class="ctrlBtn" id="dqCheck" type="button">Check</button>
        </div>

        <div class="row">
          <span class="pill">Expected:</span>
          <span class="quizBig" id="dqExpected">‚Äî</span>
        </div>

        <div class="row">
          <span class="pill">Audio file:</span>
          <span class="pill" id="dqPromptText">‚Äî</span>
        </div>
      </div>
    </div>
  </div>
  <div class="backTop"><a href="#top">‚Üë Back to top</a></div>

  <!-- WORD QUIZ (words.json) -->
  <h2 id="sec-word-quiz">‡§ó‡•Å‡§£‡§ø‡§§-‡§∂‡§¨‡•ç‡§¶-‡§≤‡•á‡§ñ‡§®-‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä (listen ‚Üí write)</h2>
   <div class="card cardAccent card--wordQuiz">
    <p class="small" style="margin: 0 0 10px;">
      <b>How to use:</b> Click <b>Next (play)</b> to hear a word. Write it on the canvas <i>or</i> type it in the box.
      Click <b>Check</b> (typing is graded). Use <b>Replay</b> to hear again, <b>Clear</b> to erase, and <b>Reveal</b> to see the answer.
    </p>

    <div class="row">
      <span class="pill" id="wqLoadStatus">Loading words.json‚Ä¶</span>
      <label>
        Level:
        <select id="wqLevel">
          <option value="all" selected>All</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
      </label>
    </div>

    <div class="row">
      <button class="ctrlBtn" id="wqNext" type="button">Next (play)</button>
      <button class="ctrlBtn" id="wqReplay" type="button">Replay</button>
      <button class="ctrlBtn" id="wqClear" type="button">Clear</button>
      <button class="ctrlBtn" id="wqReveal" type="button">Reveal</button>
      <button class="ctrlBtn" id="wqReset" type="button">Reset score</button>

      <span class="pill" id="wqResult">Ready</span>
      <span class="pill" id="wqScore">‚úÖ 0  ‚ùå 0  üî• 0 (best 0)</span>
    </div>

    <div class="quizGrid">
      <div>
        <canvas class="drawCanvas" id="wordCanvas" width="1400" height="520"></canvas>
        <p class="small">Note: Scoring uses the typed answer; the drawing is for practice.</p>
      </div>

      <div>
        <div class="row" style="margin-top:0;">
          <span class="pill">Type what you wrote (Devanagari):</span>
        </div>
        <input class="textboxDeva" id="wqTyped" placeholder="‡§â‡§¶‡§æ: ‡§è‡§ï‡§Æ‡•ç" autocomplete="off" />
        <div class="row">
          <button class="ctrlBtn" id="wqCheck" type="button">Check</button>
        </div>

        <div class="row">
          <span class="pill">Expected:</span>
          <span class="quizBig" id="wqExpected">‚Äî</span>
        </div>

        <div class="row">
          <span class="pill">Audio file:</span>
          <span class="pill" id="wqPromptText">‚Äî</span>
        </div>
      </div>
    </div>
  </div>
<div class="backTop"><a href="#top">‚Üë Back to top</a></div>
<h2 id="sec-word-recog">‡§ó‡•Å‡§£‡§ø‡§§-‡§∂‡§¨‡•ç‡§¶-‡§∂‡•ç‡§∞‡§µ‡§£-‡§™‡§†‡§®‡§æ‡§µ‡§ó‡§Æ‡§®‡§Æ‡•ç gu·πáita-≈õabda-≈õrava·πáa-pa·π≠hanƒÅvagamanam </h2>

<div class="card cardAccent card--wordRecog">
  <p class="small" style="margin: 0 0 10px;">
    <b>How to use:</b> Choose a mode. In <b>Hear ‚Üí Choose</b>, click <b>Play</b> then pick the word you heard.
    In <b>Read ‚Üí Choose</b>, read the prompt and pick the matching word. Your streak and score update automatically.
  </p>

  <div class="row">
    <span class="pill" id="wrLoadStatus">Words: (loading‚Ä¶)</span>

    <label>
      Level:
      <select id="wrLevel">
        <option value="all" selected>All</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>
    </label>

    <label><input type="radio" name="wrMode" value="hear" checked> Hear ‚Üí Choose</label>
    <label><input type="radio" name="wrMode" value="read"> Read ‚Üí Choose</label>

    <button class="ctrlBtn" id="wrPlay" type="button">Play</button>
    <button class="ctrlBtn" id="wrNext" type="button">Next</button>
    <button class="ctrlBtn" id="wrReset" type="button">Reset</button>

    <span class="pill" id="wrResult">Ready</span>
    <span class="pill" id="wrScore">‚úÖ 0  ‚ùå 0  üî• 0 (best 0)</span>
  </div>

  <div class="row" style="align-items:flex-start;">
    <div style="min-width: 220px;">
      <div class="small" style="margin: 0 0 6px;"><b>Prompt</b></div>
      <div class="quizBig" id="wrPromptBox">‚Äî</div>
      <div class="small" style="margin-top:10px;">
        <span class="pill">Audio:</span>
        <span class="pill" id="wrAudioFile">‚Äî</span>
      </div>
    </div>

    <div style="flex: 1;">
      <div class="small" style="margin: 0 0 6px;"><b>Choose one</b></div>
      <div class="grid" id="wrChoices" style="grid-template-columns: repeat(4, minmax(90px, 1fr)); max-width: 760px;"></div>
    </div>
  </div>
</div>


<div class="backTop"><a href="#top">‚Üë Back to top</a></div>
<h2 id="sec-conj">‡§∏‡§Ç‡§Ø‡•Å‡§ï‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞‡§æ‡§£‡§ø / sa·πÉyuktƒÅk·π£arƒÅ·πái ‚Äî Conjunct consonants</h2>
<div class="card cardAccent card--gunita">
  <p class="small" style="margin:0 0 8px;">
    <b>How to use:</b><br>
    Select a <b>Module</b> to choose a conjunct group.<br>
    Use <b>Prev</b> / <b>Next</b> to browse.<br>
    Click <b>Play</b> to hear the conjunct or a word containing it.<br>
    Special conjuncts show their formation (e.g. <b>‡§ú‡•ç + ‡§û ‚Üí ‡§ú‡•ç‡§û</b>).
  </p>
  <p class="small" style="margin:0 0 10px;">
  <b>Browse + Practice:</b> Start with <b>‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü‡§æ‡§®‡§ø</b> or Special consonants where you can also see how the conjunct is formed
    (e.g., <b>‡§§‡•ç + ‡§∞ ‚Üí ‡§§‡•ç‡§∞</b>). Use the quizzes for listening and reading recognition.
  </p>

  <div class="row">
    <span class="pill" id="cjLoad">Conjuncts: (loading‚Ä¶)</span>

    <label>
      Module:
      <select id="cjModule">
        <option value="A" selected>‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü‡§æ‡§®‡§ø (Special)</option>
        <option value="B">‡§∞‡§ï‡§æ‡§∞‡§æ‡§®‡•ç‡§§ (‚Ä¶ + ‡§∞)</option>
        <option value="C">Common clusters</option>
        <option value="D">‡§∞‡•ç as first consonant</option>
        <option value="E">Stacked/multiletter/busy consonants</option>
        <option value="ALL">All</option>
      </select>
    </label>

    <button class="ctrlBtn" id="cjPrev" type="button">Prev</button>
    <button class="ctrlBtn" id="cjPlay" type="button">Play</button>
    <button class="ctrlBtn" id="cjNext" type="button">Next</button>

    <span class="pill" id="cjStatus">Ready</span>
  </div>

  <div class="row" style="align-items:flex-start;">
    <div style="min-width: 260px;">
      <div class="small" style="margin:0 0 6px;"><b>Conjunct</b></div>
      <div class="quizBig" id="cjForm">‚Äî</div>

      <div class="small" style="margin-top:10px;">
        <span class="pill">Hint:</span> <span class="pill" id="cjHint">‚Äî</span>
      </div>

      <div id="cjFormationBox" style="margin-top:10px; display:none;">
        <div class="small" style="margin:0 0 6px;"><b>Formation</b></div>
        <div class="formation" id="cjFormation">‚Äî</div>
      </div>

      <div class="small" style="margin-top:10px;">
        <span class="pill">Audio:</span> <span class="pill" id="cjAudio">‚Äî</span>
      </div>
    </div>

    <div style="flex: 1;">
      <div class="small" style="margin:0 0 6px;"><b>Practice word (carrier)</b></div>
      <div class="quizBig" id="cjWord">‚Äî</div>
      <div class="small" style="margin-top:10px;">
        <span class="pill">Word hint:</span> <span class="pill" id="cjWordHint">‚Äî</span>
      </div>
      <div class="small" style="margin-top:10px;">
        Click <b>Play</b> to hear either the conjunct (if available) or a word containing it.
      </div>
    </div>
  </div>
</div>

<div class="card cardAccent card--conj">
  <h3 style="margin:0 0 8px;">Conjunct Recognition Quiz</h3>
  <p class="small" style="margin:0 0 10px;">
    Choose a mode. In <b>Hear ‚Üí Choose</b>, click <b>Play</b> and pick the correct conjunct.
    In <b>Read ‚Üí Choose</b>, read the hint (IAST) and pick the matching conjunct. 
	Note that it corresponds to the consonant type selected in <b>Module</b> above.
  </p>

  <div class="row">
    <label><input type="radio" name="cqMode" value="hear" checked> Hear ‚Üí Choose</label>
    <label><input type="radio" name="cqMode" value="read"> Read ‚Üí Choose</label>

    <button class="ctrlBtn" id="cqPlay" type="button">Play</button>
    <button class="ctrlBtn" id="cqNext" type="button">Next</button>
    <button class="ctrlBtn" id="cqReset" type="button">Reset</button>

    <span class="pill" id="cqResult">Ready</span>
    <span class="pill" id="cqScore">‚úÖ 0  ‚ùå 0  üî• 0 (best 0)</span>
  </div>

  <div class="row" style="align-items:flex-start;">
    <div style="min-width: 220px;">
      <div class="small" style="margin:0 0 6px;"><b>Prompt</b></div>
      <div class="quizBig" id="cqPrompt">‚Äî</div>
    </div>

    <div style="flex:1;">
      <div class="small" style="margin:0 0 6px;"><b>Choose one</b></div>
      <div class="grid" id="cqChoices" style="grid-template-columns: repeat(4, minmax(90px, 1fr)); max-width: 760px;"></div>
    </div>
  </div>
</div>

<div class="backTop"><a href="#top">‚Üë Back to top</a></div>
<!-- Conjunct Word Writing Quiz -->

<section id="sec-conj-word-quiz" class="card cardAccent card--conjQuiz" style="margin-top:18px;">
  <h2 style="margin:0 0 6px;">‡§∏‡§Ç‡§Ø‡•Å‡§ï‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞-‡§∂‡§¨‡•ç‡§¶-‡§≤‡•á‡§ñ‡§®-‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä (Conjunct Word Writing Quiz)</h2>

  <p class="small" style="margin:0 0 10px;">
    <b>How to use:</b> Click <b>Next (play)</b> (or <b>Play</b>) to hear a word that contains a conjunct.
    Write it on the canvas <i>or</i> type it in the box. Click <b>Check</b> to compare (typing is graded).
  </p>

  <div class="row" style="margin-top:8px;">
    <span class="pill" id="cwqLoad">Loading‚Ä¶</span>

    <label>
      Module:
<select id="cwqModule">
  <option value="ALL" selected>All</option>
  <option value="A">A ‚Äî ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü‡§æ‡§®‡§ø (Special)</option>
  <option value="B">B ‚Äî ‡§∞‡§ï‡§æ‡§∞‡§æ‡§®‡•ç‡§§ (‚Ä¶ + ‡§∞)</option>
  <option value="C">C ‚Äî Common clusters</option>
  <option value="D">D ‚Äî ‡§∞‡•ç as first consonant</option>
  <option value="E">E ‚Äî Stacked / complex</option>
</select>
    </label>

    <label>
      Level:
      <select id="cwqLevel">
        <option value="all" selected>All</option>
        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
      </select>
    </label>

<button class="ctrlBtn" id="cwqNext" type="button">Next (play)</button>
<button class="ctrlBtn" id="cwqReplay" type="button">Replay</button>
<button class="ctrlBtn" id="cwqClear" type="button">Clear</button>
<button class="ctrlBtn" id="cwqRevealBtn" type="button">Reveal</button>
<button class="ctrlBtn" id="cwqReset" type="button">Reset score</button>

<span class="pill" id="cwqResult">Ready</span>
<span class="pill" id="cwqScore">‚úÖ 0  ‚ùå 0  üî• 0 (best 0)</span>

    <span class="pill" id="cwqResult">Ready</span>
    <span class="pill" id="cwqScore">‚úÖ 0  ‚ùå 0  üî• 0 (best 0)</span>
  </div>

<div class="quizGrid">
  <div>
    <canvas class="drawCanvas" id="cwqCanvas" width="1400" height="520"></canvas>
    <p class="small">Note: Scoring uses the typed answer; the drawing is for practice.</p>
  </div>

  <div>
    <div class="row" style="margin-top:0;">
      <span class="pill">Type what you wrote (Devanagari):</span>
    </div>

    <input class="textboxDeva" id="cwqTyped" placeholder="‡§â‡§¶‡§æ: ‡§ï‡•ç‡§∑‡§Æ‡§æ" autocomplete="off" />

    <div class="row">
      <button class="ctrlBtn" id="cwqCheck" type="button">Check</button>
    </div>

    <div class="row">
      <span class="pill">Expected:</span>
      <span class="quizBig" id="cwqExpected">‚Äî</span>
    </div>

    <div class="row">
      <span class="pill">Hint:</span>
      <span class="pill" id="cwqHint">‚Äî</span>
    </div>

    <div class="row">
      <span class="pill">Audio file:</span>
      <span class="pill" id="cwqFile">‚Äî</span>
    </div>
  </div>
</div>

    </div>
</div>

</section>
<div class="backTop"><a href="#top">‚Üë Back to top</a></div>
  <p class="small">Developed by Samskritabharati USA</p>

  <script>
    const AUDIO_BASE_URL = "https://laksiyer.github.io/ucchAraNam/audio/";
    const HALANTA = "‡•ç";

    // -----------------------------
    // Load words.json (Word quiz)
    // -----------------------------
    let WORDS = [];
    let WORDS_READY = false;

    const wqLoadStatus = document.getElementById("wqLoadStatus");
    async function loadWordsJson() {
      try {
        wqLoadStatus.textContent = "Loading words.json‚Ä¶";
        const res = await fetch("words.json?ts=" + Date.now(), { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        WORDS = (data || []).filter(x => x && x.word && x.file);
        WORDS_READY = WORDS.length > 0;
        window.WORDS = WORDS;
        window.WORDS_READY = WORDS_READY;

        wqLoadStatus.textContent = WORDS_READY ? `Loaded ${WORDS.length} words` : "words.json loaded but empty";
 	  } catch (e) {
		console.error(e);
		WORDS_READY = false;
		window.WORDS_READY = false;
		window.WORDS = [];
		wqLoadStatus.textContent = "Could not load words.json (check filename/location)";
	  }

    }

    // --- DATA ---
    const vowels = [
      { key:"a",  deva:"‡§Ö",  iast:"a",   hk:"a",  hint:"a",   file:"a.mp3" },
      { key:"aa", deva:"‡§Ü",  iast:"ƒÅ",   hk:"A",  hint:"ƒÅ",   file:"aa.mp3" },
      { key:"i",  deva:"‡§á",  iast:"i",   hk:"i",  hint:"i",   file:"i.mp3" },
      { key:"ii", deva:"‡§à",  iast:"ƒ´",   hk:"I",  hint:"ƒ´",   file:"ii.mp3" },
      { key:"u",  deva:"‡§â",  iast:"u",   hk:"u",  hint:"u",   file:"u.mp3" },
      { key:"uu", deva:"‡§ä",  iast:"≈´",   hk:"U",  hint:"≈´",   file:"uu.mp3" },
      { key:"ri", deva:"‡§ã",  iast:"·πõ",   hk:"R",  hint:"·πõ",   file:"ri.mp3" },
      { key:"rri",deva:"‡•†",  iast:"·πù",   hk:"RR", hint:"·πù",   file:"rri.mp3" },
      { key:"lr", deva:"‡§å",  iast:"·∏∑",   hk:"L",  hint:"·∏∑",   file:"lr.mp3" },
      { key:"e",  deva:"‡§è",  iast:"e",   hk:"e",  hint:"e",   file:"e.mp3" },
      { key:"ai", deva:"‡§ê",  iast:"ai",  hk:"ai", hint:"ai",  file:"ai.mp3" },
      { key:"o",  deva:"‡§ì",  iast:"o",   hk:"o",  hint:"o",   file:"o.mp3" },
      { key:"au", deva:"‡§î",  iast:"au",  hk:"au", hint:"au",  file:"au.mp3" },
      { key:"am", deva:"‡§Ö‡§Ç", iast:"a·πÉ",  hk:"aM", hint:"a·πÉ",  file:"am.mp3" },
      { key:"ah", deva:"‡§Ö‡§É", iast:"a·∏•",  hk:"aH", hint:"a·∏•",  file:"ah.mp3" }
    ];

    const vargiya = [
      { key:"ka",  deva:"‡§ï", iast:"ka",  hk:"ka",  hint:"ka",  file:"ka.mp3" },
      { key:"kha", deva:"‡§ñ", iast:"kha", hk:"kha", hint:"kha", file:"kha.mp3" },
      { key:"ga",  deva:"‡§ó", iast:"ga",  hk:"ga",  hint:"ga",  file:"ga.mp3" },
      { key:"gha", deva:"‡§ò", iast:"gha", hk:"gha", hint:"gha", file:"gha.mp3" },
      { key:"nga", deva:"‡§ô", iast:"·πÖa",  hk:"Ga",  hint:"·πÖa",  file:"nga.mp3" },

      { key:"ca",  deva:"‡§ö", iast:"ca",  hk:"ca",  hint:"ca",  file:"ca.mp3" },
      { key:"cha", deva:"‡§õ", iast:"cha", hk:"cha", hint:"cha", file:"cha.mp3" },
      { key:"ja",  deva:"‡§ú", iast:"ja",  hk:"ja",  hint:"ja",  file:"ja.mp3" },
      { key:"jha", deva:"‡§ù", iast:"jha", hk:"jha", hint:"jha", file:"jha.mp3" },
      { key:"nya", deva:"‡§û", iast:"√±a",  hk:"Ja",  hint:"√±a",  file:"nya.mp3" },

      /* Retroflex base sounds (your gunita files should be: tta_a.mp3 etc) */
      { key:"tta",  deva:"‡§ü", iast:"·π≠a",  hk:"Ta",  hint:"·π≠a",  file:"ta_retro.mp3" },
      { key:"ttha", deva:"‡§†", iast:"·π≠ha", hk:"Tha", hint:"·π≠ha", file:"tha_retro.mp3" },
      { key:"dda",  deva:"‡§°", iast:"·∏ça",  hk:"Da",  hint:"·∏ça",  file:"da_retro.mp3" },
      { key:"ddha", deva:"‡§¢", iast:"·∏çha", hk:"Dha", hint:"·∏çha", file:"dha_retro.mp3" },
      { key:"nna",  deva:"‡§£", iast:"·πáa",  hk:"Na",  hint:"·πáa",  file:"na_retro.mp3" },

      { key:"ta",  deva:"‡§§", iast:"ta",  hk:"ta",  hint:"ta",  file:"ta.mp3" },
      { key:"tha", deva:"‡§•", iast:"tha", hk:"tha", hint:"tha", file:"tha.mp3" },
      { key:"da",  deva:"‡§¶", iast:"da",  hk:"da",  hint:"da",  file:"da.mp3" },
      { key:"dha", deva:"‡§ß", iast:"dha", hk:"dha", hint:"dha", file:"dha.mp3" },
      { key:"na",  deva:"‡§®", iast:"na",  hk:"na",  hint:"na",  file:"na.mp3" },

      { key:"pa",  deva:"‡§™", iast:"pa",  hk:"pa",  hint:"pa",  file:"pa.mp3" },
      { key:"pha", deva:"‡§´", iast:"pha", hk:"pha", hint:"pha", file:"pha.mp3" },
      { key:"ba",  deva:"‡§¨", iast:"ba",  hk:"ba",  hint:"ba",  file:"ba.mp3" },
      { key:"bha", deva:"‡§≠", iast:"bha", hk:"bha", hint:"bha", file:"bha.mp3" },
      { key:"ma",  deva:"‡§Æ", iast:"ma",  hk:"ma",  hint:"ma",  file:"ma.mp3" }
    ];

    const avargiya = [
      { key:"ya", deva:"‡§Ø", iast:"ya", hk:"ya", hint:"ya", file:"ya.mp3" },
      { key:"ra", deva:"‡§∞", iast:"ra", hk:"ra", hint:"ra", file:"ra.mp3" },
      { key:"la", deva:"‡§≤", iast:"la", hk:"la", hint:"la", file:"la.mp3" },
      { key:"va", deva:"‡§µ", iast:"va", hk:"va", hint:"va", file:"va.mp3" },
      { key:"sha",deva:"‡§∂", iast:"≈õa", hk:"za", hint:"≈õa", file:"sha_palatal.mp3" },
      { key:"ssa",deva:"‡§∑", iast:"·π£a", hk:"Sa", hint:"·π£a", file:"sha_retro.mp3" },
      { key:"sa", deva:"‡§∏", iast:"sa", hk:"sa", hint:"sa", file:"sa.mp3" },
      { key:"ha", deva:"‡§π", iast:"ha", hk:"ha", hint:"ha", file:"ha.mp3" }
    ];

    // Matras for gunita (NO ‡•° / ‡•£)
    const matras = [
      { key:"a",   deva:"",  vowelFile:"a.mp3"   },
      { key:"aa",  deva:"‡§æ", vowelFile:"aa.mp3"  },
      { key:"i",   deva:"‡§ø", vowelFile:"i.mp3"   },
      { key:"ii",  deva:"‡•Ä", vowelFile:"ii.mp3"  },
      { key:"u",   deva:"‡•Å", vowelFile:"u.mp3"   },
      { key:"uu",  deva:"‡•Ç", vowelFile:"uu.mp3"  },
      { key:"ri",  deva:"‡•É", vowelFile:"ri.mp3"  },
      { key:"rri", deva:"‡•Ñ", vowelFile:"rri.mp3" },
      { key:"lr",  deva:"‡•¢", vowelFile:"lr.mp3"  },
      { key:"e",   deva:"‡•á", vowelFile:"e.mp3"   },
      { key:"ai",  deva:"‡•à", vowelFile:"ai.mp3"  },
      { key:"o",   deva:"‡•ã", vowelFile:"o.mp3"   },
      { key:"au",  deva:"‡•å", vowelFile:"au.mp3"  },
      { key:"am",  deva:"‡§Ç", vowelFile:"am.mp3"  },
      { key:"ah",  deva:"‡§É", vowelFile:"ah.mp3"  }
    ];

    const allItems = [...vowels, ...vargiya, ...avargiya];
    const byKey = new Map(allItems.map(x => [x.key, x]));
    const quizPool = [...vargiya, ...avargiya];

    // UI
    const status = document.getElementById("status");
    const showHint = document.getElementById("showHint");
    const schemeSel = document.getElementById("scheme");
    const quizMode = document.getElementById("quizMode");
    const playNext = document.getElementById("playNext");
    const qPrompt = document.getElementById("qPrompt");
    const scorePill = document.getElementById("scorePill");
    const resetScoreBtn = document.getElementById("resetScore");
    const quizTypeRadios = document.querySelectorAll('input[name="quizType"]');

    // Gunita UI
    const gunitaStatus = document.getElementById("gunita-status");
    const gunitaDisplay = document.getElementById("gunita-display");
    const showHalantaGunita = document.getElementById("showHalantaGunita");
    const halantaNoteGunita = document.getElementById("halantaNoteGunita");

    // State
    let scheme = schemeSel.value;
    let quizType = "listen";
    let quizAnswerKey = null;

    let correctCount = 0;
    let incorrectCount = 0;
    let streak = 0;
    let bestStreak = 0;
    let missedThisQuestion = false;

    let selectedConsonant = null;

    // Audio
    const player = new Audio();
    player.preload = "auto";

    function setStatus(msg) { status.textContent = msg; }

    function labelOf(x) {
      if (!x) return "";
      return (x && x[scheme]) ? x[scheme] : (x.deva || "");
    }

    function gunitaConsonantLabel(c) {
      if (!c) return "";
      if (scheme === "deva" && showHalantaGunita.checked) return (c.deva || "") + HALANTA;
      return labelOf(c);
    }

function playFile(file, msg) {
  try { player.pause(); player.currentTime = 0; } catch(e) {}
  const url = AUDIO_BASE_URL + file;
  setStatus(msg);
  player.src = url;
  player.play().catch(() => {
    console.warn("Could not play:", url);
    setStatus("Missing audio: " + file);
  });
}

    async function tryPlaySingle(file) {
      return new Promise((resolve, reject) => {
        try { player.pause(); player.currentTime = 0; } catch(e) {}
        player.src = AUDIO_BASE_URL + file;
        player.onended = resolve;
        player.onerror = () => reject(new Error("Missing: " + file));
        player.play().catch(reject);
      });
    }

    async function playSequence(files) {
      for (const f of files) {
        await new Promise((resolve, reject) => {
          try { player.pause(); player.currentTime = 0; } catch(e) {}
          player.src = AUDIO_BASE_URL + f;
          player.onended = resolve;
          player.onerror = reject;
          player.play().catch(reject);
        });
      }
    }

    // Matra sound first, then gunita file; fallback if missing
    async function playGunita(consonant, matra) {
      const gunitaFile = `${consonant.key}_${matra.key}.mp3`;
      await playSequence([matra.vowelFile]);
      try {
        await tryPlaySingle(gunitaFile);
      } catch (e) {
        await playSequence([consonant.file, matra.vowelFile]);
      }
    }

    function clearFeedback() {
      document.querySelectorAll(".letterBtn").forEach(b => b.classList.remove("correct","wrong"));
    }

    function updateScoreUI() {
      scorePill.textContent = `‚úÖ ${correctCount}  ‚ùå ${incorrectCount}  üî• ${streak} (best ${bestStreak})`;
    }

    function resetScore() {
      correctCount = 0;
      incorrectCount = 0;
      streak = 0;
      bestStreak = 0;
      missedThisQuestion = false;
      updateScoreUI();
      clearFeedback();
      setStatus("Ready");
      if (!quizMode.checked) qPrompt.textContent = "Quiz off";
    }

    function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    function startQuestion() {
      clearFeedback();
      const x = pick(quizPool);
      quizAnswerKey = x.key;
      missedThisQuestion = false;

      if (quizType === "listen") {
        qPrompt.textContent = "Listen ‚Üí Click";
        playFile(x.file, "Quiz sound");
      } else {
        qPrompt.textContent = "See ‚Üí Guess (then Play)";
        setStatus("Shown: " + labelOf(x));
      }
    }

    function renderButtons(containerId, items, modeLine=false) {
      const container = document.getElementById(containerId);
      items.forEach(x => {
        const b = document.createElement("button");
        b.className = "letterBtn";
        b.dataset.key = x.key;
        b.textContent = labelOf(x);
        if (modeLine) b.style.padding = "10px 14px";

        const updateTitle = () => {
          b.title = showHint.checked ? (x.hint + " (" + x.file + ")") : "";
        };
        updateTitle();
        showHint.addEventListener("change", updateTitle);

        b.onclick = () => {
          if (!quizMode.checked) {
            playFile(x.file, labelOf(x) + (showHint.checked ? " = " + x.hint : ""));
            return;
          }

          clearFeedback();

          if (x.key === quizAnswerKey) {
            b.classList.add("correct");
            qPrompt.textContent = "‚úÖ Correct!";

            correctCount += 1;
            if (missedThisQuestion) {
              incorrectCount += 1;
              streak = 0;
            } else {
              streak += 1;
              if (streak > bestStreak) bestStreak = streak;
            }
            updateScoreUI();

            playFile(x.file, "Correct");
            setTimeout(startQuestion, 800);
          } else {
            b.classList.add("wrong");
            qPrompt.textContent = "‚ùå Try again";
            missedThisQuestion = true;

            if (quizType === "listen" && quizAnswerKey) {
              const target = byKey.get(quizAnswerKey);
              if (target) setTimeout(() => playFile(target.file, "Try again"), 200);
            }
          }
        };

        container.appendChild(b);
      });
    }

    function renderGunita() {
      const cDiv = document.getElementById("gunita-consonants");
      const mDiv = document.getElementById("gunita-matras");
      cDiv.innerHTML = "";
      mDiv.innerHTML = "";

      const consonants = [...vargiya, ...avargiya];

      consonants.forEach(c => {
        const b = document.createElement("button");
        b.className = "letterBtn";
        b.dataset.key = c.key;
        b.textContent = gunitaConsonantLabel(c);
        b.title = "Select consonant";

        b.onclick = () => {
          selectedConsonant = c;
          gunitaStatus.textContent = "Selected: " + gunitaConsonantLabel(c);
          gunitaDisplay.textContent = gunitaConsonantLabel(c);
          playFile(c.file, "Selected");
        };
        cDiv.appendChild(b);
      });

      matras.forEach(m => {
        const b = document.createElement("button");
        b.className = "letterBtn";
        b.dataset.matra = m.key;
        b.textContent = m.deva || "‡§Ö";
        b.title = "Apply mƒÅtrƒÅ";

        b.onclick = async () => {
          if (!selectedConsonant) { alert("First select a consonant (e.g., ‡§ï)."); return; }
          const combined = (selectedConsonant.deva || "") + (m.deva || "");
          gunitaDisplay.textContent = combined;
          await playGunita(selectedConsonant, m);
        };

        mDiv.appendChild(b);
      });
    }

    function rerenderTextsForSchemeChange() {
      document.querySelectorAll("#grid-vowels .letterBtn, #grid-vargiya .letterBtn, #line-avargiya .letterBtn")
        .forEach(btn => {
          const x = byKey.get(btn.dataset.key);
          if (x) btn.textContent = labelOf(x);
        });

      renderGunita();

      if (quizMode.checked && quizType === "reverse" && quizAnswerKey) {
        const x = byKey.get(quizAnswerKey);
        setStatus("Shown: " + labelOf(x));
      }
    }

    // Initial render
    renderButtons("grid-vowels", vowels);
    renderButtons("grid-vargiya", vargiya);
    renderButtons("line-avargiya", avargiya, true);
    renderGunita();
    updateScoreUI();

    schemeSel.addEventListener("change", () => {
      scheme = schemeSel.value;
      if (scheme !== "deva") {
        showHalantaGunita.checked = false;
        halantaNoteGunita.classList.remove("show");
      }
      rerenderTextsForSchemeChange();
    });

    showHalantaGunita.addEventListener("change", () => {
      halantaNoteGunita.classList.toggle("show", showHalantaGunita.checked && scheme === "deva");
      renderGunita();
      if (selectedConsonant) {
        gunitaStatus.textContent = "Selected: " + gunitaConsonantLabel(selectedConsonant);
      }
    });

    quizTypeRadios.forEach(r => r.addEventListener("change", () => {
      quizType = document.querySelector('input[name="quizType"]:checked').value;
      if (quizMode.checked) startQuestion();
    }));

    playNext.addEventListener("click", () => {
      if (!quizMode.checked) return;
      if (quizType === "reverse" && quizAnswerKey) {
        const x = byKey.get(quizAnswerKey);
        playFile(x.file, "Reveal");
      } else {
        startQuestion();
      }
    });

    quizMode.addEventListener("change", () => {
      clearFeedback();
      if (quizMode.checked) {
        startQuestion();
      } else {
        quizAnswerKey = null;
        missedThisQuestion = false;
        qPrompt.textContent = "Quiz off";
        setStatus("Ready");
      }
    });

    resetScoreBtn.addEventListener("click", resetScore);

    // -----------------------------
    // Gunita Writing Quiz (akshara)
    // -----------------------------
    const dqNext = document.getElementById("dqNext");
    const dqReplay = document.getElementById("dqReplay");
    const dqClear = document.getElementById("dqClear");
    const dqReveal = document.getElementById("dqReveal");
    const dqReset = document.getElementById("dqReset");
    const dqCheck = document.getElementById("dqCheck");

    const dqResult = document.getElementById("dqResult");
    const dqScore = document.getElementById("dqScore");
    const dqExpected = document.getElementById("dqExpected");
    const dqPromptText = document.getElementById("dqPromptText");
    const dqTyped = document.getElementById("dqTyped");

    const canvas = document.getElementById("drawCanvas");
    const ctx = canvas.getContext("2d");

    let dqCorrect = 0, dqIncorrect = 0, dqStreak = 0, dqBest = 0;
    let dqCurrent = null; // { expectedDeva, consonantKey, matraKey, file }

    function dqUpdateScore() {
      dqScore.textContent = `‚úÖ ${dqCorrect}  ‚ùå ${dqIncorrect}  üî• ${dqStreak} (best ${dqBest})`;
    }

    function dqSetPill(msg, kind="neutral") {
      dqResult.textContent = msg;
      dqResult.classList.remove("okPill","badPill");
      if (kind === "ok") dqResult.classList.add("okPill");
      if (kind === "bad") dqResult.classList.add("badPill");
    }

    function dqPickGunita() {
      const consonants = [...vargiya, ...avargiya];
      const c = pick(consonants);
      const m = pick(matras);
      const expected = (c.deva || "") + (m.deva || "");
      const file = `${c.key}_${m.key}.mp3`;
      return { expectedDeva: expected, consonantKey: c.key, matraKey: m.key, file };
    }

    function dqPlayCurrent() {
      if (!dqCurrent) return;
      playFile(dqCurrent.file, "Gunita quiz");
    }

    function dqClearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.globalAlpha = 0.08;
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(40, canvas.height/2);
      ctx.lineTo(canvas.width-40, canvas.height/2);
      ctx.stroke();
      ctx.restore();
    }

    function dqNewQuestion() {
      dqCurrent = dqPickGunita();
      dqExpected.textContent = "‚Äî";
      dqPromptText.textContent = dqCurrent.file;
      dqTyped.value = "";
      dqSetPill("Listen and write", "neutral");
      dqClearCanvas();
      dqPlayCurrent();
    }

    function dqRevealAnswer() {
      if (!dqCurrent) return;
      dqExpected.textContent = dqCurrent.expectedDeva;
      dqSetPill("Revealed", "neutral");
    }

    function normalizeDeva(s) {
      return (s || "").trim().replace(/\s+/g, "");
    }

    function dqCheckTyped() {
      if (!dqCurrent) return;

      const user = normalizeDeva(dqTyped.value);
      const exp = normalizeDeva(dqCurrent.expectedDeva);

      dqExpected.textContent = dqCurrent.expectedDeva;

      if (!user) {
        dqSetPill("Type your answer first (or press Reveal).", "bad");
        return;
      }

      if (user === exp) {
        dqCorrect += 1;
        dqStreak += 1;
        dqBest = Math.max(dqBest, dqStreak);
        dqSetPill("‚úÖ Correct", "ok");
      } else {
        dqIncorrect += 1;
        dqStreak = 0;
        dqSetPill("‚ùå Not matched (see Expected)", "bad");
      }
      dqUpdateScore();
    }

    function dqResetAll() {
      dqCorrect = 0; dqIncorrect = 0; dqStreak = 0; dqBest = 0;
      dqUpdateScore();
      dqSetPill("Ready", "neutral");
      dqExpected.textContent = "‚Äî";
      dqPromptText.textContent = "‚Äî";
      dqTyped.value = "";
      dqClearCanvas();
      dqCurrent = null;
    }

    function dqPos(evt, canv) {
      const rect = canv.getBoundingClientRect();
      const clientX = (evt.touches && evt.touches[0]) ? evt.touches[0].clientX : evt.clientX;
      const clientY = (evt.touches && evt.touches[0]) ? evt.touches[0].clientY : evt.clientY;
      const x = (clientX - rect.left) * (canv.width / rect.width);
      const y = (clientY - rect.top)  * (canv.height / rect.height);
      return {x,y};
    }

    function wireCanvas(canv, context) {
      let isDown = false;
      let lx = 0, ly = 0;

      function start(evt) {
        evt.preventDefault();
        isDown = true;
        const p = dqPos(evt, canv);
        lx = p.x; ly = p.y;
      }
      function move(evt) {
        if (!isDown) return;
        evt.preventDefault();
        const p = dqPos(evt, canv);

        context.save();
        context.lineCap = "round";
        context.lineJoin = "round";
        context.strokeStyle = "#111827";
        context.lineWidth = 18;
        context.beginPath();
        context.moveTo(lx, ly);
        context.lineTo(p.x, p.y);
        context.stroke();
        context.restore();

        lx = p.x; ly = p.y;
      }
      function end(evt) {
        if (!isDown) return;
        evt.preventDefault();
        isDown = false;
      }

      canv.addEventListener("mousedown", start);
      canv.addEventListener("mousemove", move);
      window.addEventListener("mouseup", end);

      canv.addEventListener("touchstart", start, {passive:false});
      canv.addEventListener("touchmove", move, {passive:false});
      canv.addEventListener("touchend", end, {passive:false});
    }

    wireCanvas(canvas, ctx);

    dqNext.addEventListener("click", dqNewQuestion);
    dqReplay.addEventListener("click", dqPlayCurrent);
    dqClear.addEventListener("click", dqClearCanvas);
    dqReveal.addEventListener("click", dqRevealAnswer);
    dqReset.addEventListener("click", dqResetAll);
    dqCheck.addEventListener("click", dqCheckTyped);
    dqTyped.addEventListener("keydown", (e) => { if (e.key === "Enter") dqCheckTyped(); });

    dqClearCanvas();
    dqUpdateScore();

    // -----------------------------
    // Word Writing Quiz (words.json)
    // -----------------------------
    const wqLevel = document.getElementById("wqLevel");
    const wqNext = document.getElementById("wqNext");
    const wqReplay = document.getElementById("wqReplay");
    const wqClear = document.getElementById("wqClear");
    const wqReveal = document.getElementById("wqReveal");
    const wqReset = document.getElementById("wqReset");
    const wqCheck = document.getElementById("wqCheck");

    const wqResult = document.getElementById("wqResult");
    const wqScore = document.getElementById("wqScore");
    const wqExpected = document.getElementById("wqExpected");
    const wqPromptText = document.getElementById("wqPromptText");
    const wqTyped = document.getElementById("wqTyped");

    const wordCanvas = document.getElementById("wordCanvas");
    const wctx = wordCanvas.getContext("2d");

    let wqCorrect = 0, wqIncorrect = 0, wqStreak = 0, wqBest = 0;
    let wqCurrent = null;

    function wqUpdateScore() {
      wqScore.textContent = `‚úÖ ${wqCorrect}  ‚ùå ${wqIncorrect}  üî• ${wqStreak} (best ${wqBest})`;
    }

    function wqSetPill(msg, kind="neutral") {
      wqResult.textContent = msg;
      wqResult.classList.remove("okPill","badPill");
      if (kind === "ok") wqResult.classList.add("okPill");
      if (kind === "bad") wqResult.classList.add("badPill");
    }

    function wqClearCanvas() {
      wctx.clearRect(0, 0, wordCanvas.width, wordCanvas.height);
      wctx.save();
      wctx.globalAlpha = 0.08;
      wctx.strokeStyle = "#000";
      wctx.lineWidth = 4;
      wctx.beginPath();
      wctx.moveTo(40, wordCanvas.height/2);
      wctx.lineTo(wordCanvas.width-40, wordCanvas.height/2);
      wctx.stroke();
      wctx.restore();
    }

    function poolByLevel() {
      if (!WORDS_READY) return [];
      const lvl = wqLevel.value;
      if (lvl === "all") return WORDS;
      return WORDS.filter(x => String(x.level ?? "") === String(lvl));
    }

    function wqPickWord() {
      const pool = poolByLevel();
      if (!pool.length) return null;
      return pool[Math.floor(Math.random() * pool.length)];
    }

    function wqPlayCurrent() {
      if (!wqCurrent) return;
      playFile(wqCurrent.file, "Word quiz");
    }

    function wqNewQuestion() {
      if (!WORDS_READY) { wqSetPill("words.json not loaded yet", "bad"); return; }
      wqCurrent = wqPickWord();
      if (!wqCurrent) { wqSetPill("No words for this level", "bad"); return; }
      wqExpected.textContent = "‚Äî";
      wqPromptText.textContent = wqCurrent.file;
      wqTyped.value = "";
      wqSetPill("Listen and write", "neutral");
      wqClearCanvas();
      wqPlayCurrent();
    }

    function wqRevealAnswer() {
      if (!wqCurrent) return;
      wqExpected.textContent = wqCurrent.word;
      wqSetPill("Revealed", "neutral");
    }

    function wqCheckTyped() {
      if (!wqCurrent) return;

      const user = normalizeDeva(wqTyped.value);
      const exp = normalizeDeva(wqCurrent.word);

      wqExpected.textContent = wqCurrent.word;

      if (!user) { wqSetPill("Type your answer first (or press Reveal).", "bad"); return; }

      if (user === exp) {
        wqCorrect += 1;
        wqStreak += 1;
        wqBest = Math.max(wqBest, wqStreak);
        wqSetPill("‚úÖ Correct", "ok");
      } else {
        wqIncorrect += 1;
        wqStreak = 0;
        wqSetPill("‚ùå Not matched (see Expected)", "bad");
      }
      wqUpdateScore();
    }

    function wqResetAll() {
      wqCorrect = 0; wqIncorrect = 0; wqStreak = 0; wqBest = 0;
      wqUpdateScore();
      wqSetPill("Ready", "neutral");
      wqExpected.textContent = "‚Äî";
      wqPromptText.textContent = "‚Äî";
      wqTyped.value = "";
      wqClearCanvas();
      wqCurrent = null;
    }

    wireCanvas(wordCanvas, wctx);

    wqNext.addEventListener("click", wqNewQuestion);
    wqReplay.addEventListener("click", wqPlayCurrent);
    wqClear.addEventListener("click", wqClearCanvas);
    wqReveal.addEventListener("click", wqRevealAnswer);
    wqReset.addEventListener("click", wqResetAll);
    wqCheck.addEventListener("click", wqCheckTyped);
    wqTyped.addEventListener("keydown", (e) => { if (e.key === "Enter") wqCheckTyped(); });

    wqClearCanvas();
    wqUpdateScore();

    // finally: load words.json after page init
    loadWordsJson();
  
  // -----------------------------
  // Word Recognition Quiz (Hear‚ÜíChoose / Read‚ÜíChoose)
  // Requires: WORDS, WORDS_READY, playFile(), AUDIO_BASE_URL
  // -----------------------------
  const wrLoadStatus = document.getElementById("wrLoadStatus");
  const wrLevel = document.getElementById("wrLevel");
  const wrPlay = document.getElementById("wrPlay");
  const wrNext = document.getElementById("wrNext");
  const wrReset = document.getElementById("wrReset");
  const wrResult = document.getElementById("wrResult");
  const wrScore = document.getElementById("wrScore");
  const wrPromptBox = document.getElementById("wrPromptBox");
  const wrAudioFile = document.getElementById("wrAudioFile");
  const wrChoices = document.getElementById("wrChoices");
  const wrModeRadios = document.querySelectorAll('input[name="wrMode"]');

  let wrMode = "hear";
  let wrCorrect = 0, wrIncorrect = 0, wrStreak = 0, wrBest = 0;
  let wrAnswer = null;      // {word, file, hint, level, id}
  let wrOptions = [];       // array of 4 word objects
  let wrLocked = false;

  function wrSetResult(msg, kind="neutral") {
    wrResult.textContent = msg;
    wrResult.classList.remove("okPill","badPill");
    if (kind === "ok") wrResult.classList.add("okPill");
    if (kind === "bad") wrResult.classList.add("badPill");
  }

  function wrUpdateScore() {
    wrScore.textContent = `‚úÖ ${wrCorrect}  ‚ùå ${wrIncorrect}  üî• ${wrStreak} (best ${wrBest})`;
  }

  function wrPool() {
    if (!window.WORDS_READY || !Array.isArray(window.WORDS)) return [];
    const lvl = wrLevel.value;
    if (lvl === "all") return window.WORDS;
    return window.WORDS.filter(x => String(x.level ?? "") === String(lvl));
  }

  function wrPickOne(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function wrShuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function wrClearChoiceStyles() {
    wrChoices.querySelectorAll("button").forEach(b => b.classList.remove("correct","wrong"));
  }

  function wrRenderChoices() {
    wrChoices.innerHTML = "";
    wrOptions.forEach(opt => {
      const b = document.createElement("button");
      b.className = "letterBtn choiceBtn";
      b.textContent = opt.word;
      b.title = opt.hint ? opt.hint : "";
      b.onclick = () => wrChoose(opt, b);
      wrChoices.appendChild(b);
    });
  }

  function wrSetPrompt() {
    // Prompt box shows something useful depending on mode
    if (!wrAnswer) { wrPromptBox.textContent = "‚Äî"; return; }

    if (wrMode === "hear") {
      wrPromptBox.textContent = "üîä Listen";
    } else {
      // Read ‚Üí Choose: show a non-Devanagari prompt (hint) so they choose the matching Devanagari
      // If your hints are IAST, this works well.
      wrPromptBox.textContent = wrAnswer.hint || "(hint missing)";
    }
    wrAudioFile.textContent = wrAnswer.file || "‚Äî";
  }

  function wrPlayAudio() {
    if (!wrAnswer) return;
    if (!wrAnswer.file) return;
    playFile(wrAnswer.file, "Word");
  }

  function wrNewQuestion() {
    const pool = wrPool();
    if (!pool.length) {
      wrSetResult("No words (check level / words.json).", "bad");
      wrAnswer = null;
      wrOptions = [];
      wrChoices.innerHTML = "";
      wrSetPrompt();
      return;
    }

    wrLocked = false;
    wrSetResult("Choose the correct word", "neutral");

    // pick answer
    wrAnswer = wrPickOne(pool);

    // pick 3 distractors (different words)
    const distractors = [];
    const seen = new Set([wrAnswer.word]);
    while (distractors.length < 3 && seen.size < pool.length) {
      const d = wrPickOne(pool);
      if (!seen.has(d.word)) {
        seen.add(d.word);
        distractors.push(d);
      }
    }

    // build options
    wrOptions = wrShuffle([wrAnswer, ...distractors]);

    wrRenderChoices();
    wrSetPrompt();

    // Auto-play in Hear mode
    if (wrMode === "hear") {
      wrPlayAudio();
    }
  }

  function wrChoose(opt, btn) {
    if (!wrAnswer || wrLocked) return;

    wrClearChoiceStyles();

    if (opt.word === wrAnswer.word) {
      btn.classList.add("correct");
      wrSetResult("‚úÖ Correct", "ok");
      wrCorrect += 1;
      wrStreak += 1;
      if (wrStreak > wrBest) wrBest = wrStreak;
      wrUpdateScore();
      wrLocked = true;
      setTimeout(wrNewQuestion, 650);
    } else {
      btn.classList.add("wrong");
      wrSetResult("‚ùå Try again", "bad");
      wrIncorrect += 1;
      wrStreak = 0;
      wrUpdateScore();
      // In Hear mode, replay the audio after a wrong try (helps learning)
      if (wrMode === "hear") setTimeout(wrPlayAudio, 200);
    }
  }

  function wrResetAll() {
    wrCorrect = 0; wrIncorrect = 0; wrStreak = 0; wrBest = 0;
    wrUpdateScore();
    wrSetResult("Ready", "neutral");
    wrAnswer = null;
    wrChoices.innerHTML = "";
    wrPromptBox.textContent = "‚Äî";
    wrAudioFile.textContent = "‚Äî";
  }

  // Hook up controls
  wrModeRadios.forEach(r => r.addEventListener("change", () => {
    wrMode = document.querySelector('input[name="wrMode"]:checked').value;
    wrNewQuestion();
  }));

  wrLevel.addEventListener("change", wrNewQuestion);
  wrPlay.addEventListener("click", () => {
  wrUserHasInteracted = true; // if you‚Äôre using this flag
  if (!wrAnswer) wrNewQuestion();   // Start if needed
  else wrPlayAudio();               // Otherwise replay
  });
  wrNext.addEventListener("click", () => { wrUserHasInteracted = true; wrNewQuestion(); });
  wrReset.addEventListener("click", wrResetAll);

  // Keep the load status in sync with your words.json loader
  function wrRefreshLoadStatus() {
    if (window.WORDS_READY && Array.isArray(window.WORDS)) {
      wrLoadStatus.textContent = `Words loaded: ${window.WORDS.length}`;
    } else {
      wrLoadStatus.textContent = "Words: not loaded (check words.json)";
    }
  }

  // Call this after your words.json finishes loading.
  // If your code already calls loadWordsJson(), just add:
  // setTimeout(wrInitAfterLoad, 300);
 function wrInitAfterLoad() {
  wrRefreshLoadStatus();
  wrUpdateScore();
  wrSetResult("Ready ‚Äî click Play or Next", "neutral");
  // DO NOT auto-start with wrNewQuestion();
}


  // Safe init: try a few times (words.json might load asynchronously)
  (function bootWR(attempt=0){
    wrRefreshLoadStatus();
    if (window.WORDS_READY) {
      wrInitAfterLoad();
    } else if (attempt < 15) {
      setTimeout(() => bootWR(attempt+1), 200);
    }
  })();
  // -----------------------------
// Conjuncts loader + browser + quiz
// -----------------------------
let CONJ = [];
let CONJ_READY = false;

async function loadConjunctsJson() {
  try {
    const res = await fetch("conj/conjuncts.json?v=" + Date.now());
    if (!res.ok) throw new Error("HTTP " + res.status);
    CONJ = await res.json();
    CONJ_READY = Array.isArray(CONJ) && CONJ.length > 0;
    document.getElementById("cjLoad").textContent = CONJ_READY ? `Conjuncts loaded: ${CONJ.length}` : "Conjuncts: empty";
  } catch (e) {
    console.error(e);
    CONJ = [];
    CONJ_READY = false;
    document.getElementById("cjLoad").textContent = "Could not load conj/conjuncts.json";
  }
}
// -----------------------------
// Conjunct WORDS loader (conj/conjunct_words.json)
// -----------------------------
let CONJ_WORDS = [];
let CONJ_WORDS_READY = false;

async function loadConjunctWordsJson() {
  try {
    const res = await fetch("conj/conjunct_words.json?v=" + Date.now());
    if (!res.ok) throw new Error("HTTP " + res.status);
    CONJ_WORDS = await res.json();
    CONJ_WORDS_READY = Array.isArray(CONJ_WORDS) && CONJ_WORDS.length > 0;
  } catch (e) {
    console.error(e);
    CONJ_WORDS = [];
    CONJ_WORDS_READY = false;
  }
}

// -----------------------------
// Conjunct Word Writing Quiz
// -----------------------------
const cwqLoad = document.getElementById("cwqLoad");
const cwqModule = document.getElementById("cwqModule");
const cwqLevel = document.getElementById("cwqLevel");
const cwqNext = document.getElementById("cwqNext");
const cwqReplay = document.getElementById("cwqReplay");
const cwqCheck = document.getElementById("cwqCheck");
const cwqReset = document.getElementById("cwqReset");
const cwqResult = document.getElementById("cwqResult");
const cwqScore = document.getElementById("cwqScore");

const cwqCanvas = document.getElementById("cwqCanvas");
const cwqClear = document.getElementById("cwqClear");
const cwqTyped = document.getElementById("cwqTyped");
const cwqExpected = document.getElementById("cwqExpected");
const cwqHint = document.getElementById("cwqHint");
const cwqFile = document.getElementById("cwqFile");

const cwqRevealBtn  = document.getElementById("cwqRevealBtn");

let cwqAnswer = null; // {conj_id, word, hint, level, file, idx}
let cwqCorrect = 0, cwqIncorrect = 0, cwqStreak = 0, cwqBest = 0;

// Map conj_id -> module (from CONJ list)
function buildConjIdToModuleMap() {
  const m = new Map();
  if (Array.isArray(CONJ)) {
    CONJ.forEach(x => {
      if (x && x.id) m.set(x.id, x.module || "");
    });
  }
  return m;
}

function cwqSetResult(msg, kind="neutral") {
  cwqResult.textContent = msg;
  cwqResult.classList.remove("okPill","badPill");
  if (kind === "ok") cwqResult.classList.add("okPill");
  if (kind === "bad") cwqResult.classList.add("badPill");
}

function cwqUpdateScore() {
  cwqScore.textContent = `‚úÖ ${cwqCorrect}  ‚ùå ${cwqIncorrect}  üî• ${cwqStreak} (best ${cwqBest})`;
}

function cwqShuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function cwqPool() {
  if (!CONJ_WORDS_READY) return [];
  const lvl = cwqLevel.value;
  const mod = cwqModule.value;

  const idToMod = buildConjIdToModuleMap();

  return CONJ_WORDS.filter(w => {
    if (!w || !w.word) return false;

    // Level filter
    if (lvl !== "all" && String(w.level ?? "") !== String(lvl)) return false;

    // Module filter
    if (mod === "ALL") return true;

    const m = idToMod.get(w.conj_id);
    return m === mod;
  });
}

function cwqPickOne(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function cwqRenderMeta() {
  if (!cwqAnswer) {
    cwqExpected.textContent = "";
    cwqHint.textContent = "";
    cwqFile.textContent = "‚Äî";
    return;
  }
  cwqExpected.textContent = "‚Äî"; // hidden until Check
  cwqHint.textContent = cwqAnswer.hint || "‚Äî";
  cwqFile.textContent = cwqAnswer.file || "‚Äî";
}

function cwqPlayAudio() {
  if (!cwqAnswer || !cwqAnswer.file) return;
  playFile(cwqAnswer.file, cwqAnswer.word);
}

function cwqNewQuestion() {
  const pool = cwqPool();
  if (!pool.length) {
    cwqSetResult("No conjunct words found for this filter.", "bad");
    cwqAnswer = null;
	cwqRenderMeta();
    return;
  }
  cwqAnswer = cwqPickOne(pool);
  cwqTyped.value = "";
  cwqExpected.textContent = ""; // hide
  cwqSetResult("Write the word you hear (canvas or type).", "neutral");
  cwqRenderMeta();
  cwqPlayAudio();
}

function cwqRevealExpected() {
  if (!cwqAnswer) return;
  cwqExpected.textContent = cwqAnswer.word; // show in the existing Expected box
  cwqSetResult("Revealed ‚Äî compare with your writing.", "neutral");
}

// Normalize typed text for grading
function cwqNorm(s) {
  return (s || "")
    .replace(/\s+/g, "")          // remove spaces
    .replace(/[‡•§‡••]/g, "")         // remove danda if someone types it
    .trim();
}

function cwqCheckAnswer() {
  if (!cwqAnswer) {
    cwqSetResult("Click Next (play) first.", "bad");
    return;
  }
  const typed = cwqNorm(cwqTyped.value);
  const expected = cwqNorm(cwqAnswer.word);

  // Always show expected after checking
  cwqExpected.textContent = cwqAnswer.word;
  if (!typed) {
    cwqSetResult("Type the word to be graded (canvas is visual only).", "bad");
    return;
  }

  if (typed === expected) {
    cwqSetResult("‚úÖ Correct!", "ok");
    cwqCorrect += 1;
    cwqStreak += 1;
    if (cwqStreak > cwqBest) cwqBest = cwqStreak;
    cwqUpdateScore();
    setTimeout(cwqNewQuestion, 650);
  } else {
    cwqSetResult("‚ùå Not quite ‚Äî compare with Expected.", "bad");
    cwqIncorrect += 1;
    cwqStreak = 0;
    cwqUpdateScore();
  }
}

function cwqResetAll() {
  cwqCorrect = 0; cwqIncorrect = 0; cwqStreak = 0; cwqBest = 0;
  cwqUpdateScore();
  cwqAnswer = null;
  cwqTyped.value = "";
  cwqExpected.textContent = "";
  cwqHint.textContent = "";
  cwqFile.textContent = "‚Äî";
  cwqSetResult("Ready", "neutral");
}

cwqNext.addEventListener("click", cwqNewQuestion);
cwqReplay.addEventListener("click", cwqPlayAudio);
cwqCheck.addEventListener("click", cwqCheckAnswer);
cwqReset.addEventListener("click", cwqResetAll);
cwqClear.addEventListener("click", cwqClearCanvas);

cwqLevel.addEventListener("change", cwqNewQuestion);
cwqModule.addEventListener("change", cwqNewQuestion);

cwqRevealBtn.addEventListener("click", cwqRevealExpected);

// -----------------------------
// Canvas drawing (simple, finger/mouse friendly)
// -----------------------------
const cwqCtx = cwqCanvas.getContext("2d");

function cwqClearCanvas() {
  cwqCtx.clearRect(0, 0, cwqCanvas.width, cwqCanvas.height);
  cwqCtx.save();
  cwqCtx.globalAlpha = 0.08;
  cwqCtx.strokeStyle = "#000";
  cwqCtx.lineWidth = 4;
  cwqCtx.beginPath();
  cwqCtx.moveTo(40, cwqCanvas.height/2);
  cwqCtx.lineTo(cwqCanvas.width-40, cwqCanvas.height/2);
  cwqCtx.stroke();
  cwqCtx.restore();
}
wireCanvas(cwqCanvas, cwqCtx);
cwqClearCanvas();


// -----------------------------
// Boot: load JSON + show status
// -----------------------------
(async function bootCWQ() {
  cwqSetResult("Loading‚Ä¶", "neutral");
  await loadConjunctWordsJson();

  // CONJ should already be loaded by your existing loader; if not, load it here:
  if (!CONJ_READY) {
    try { await loadConjunctsJson(); } catch(e) {}
  }

  if (CONJ_WORDS_READY) {
    cwqLoad.textContent = `Conjunct words loaded: ${CONJ_WORDS.length}`;
    cwqSetResult("Ready ‚Äî click Next (play) to begin.", "neutral");
  } else {
    cwqLoad.textContent = "Conjunct words not loaded (check conj/conjunct_words.json)";
    cwqSetResult("Could not load conjunct words.", "bad");
  }
  cwqUpdateScore();
})();

// ---- Browse UI ----
const cjModule = document.getElementById("cjModule");
const cjPrev = document.getElementById("cjPrev");
const cjPlay = document.getElementById("cjPlay");
const cjNext = document.getElementById("cjNext");
const cjStatus = document.getElementById("cjStatus");

const cjForm = document.getElementById("cjForm");
const cjHint = document.getElementById("cjHint");
const cjFormationBox = document.getElementById("cjFormationBox");
const cjFormation = document.getElementById("cjFormation");
const cjAudio = document.getElementById("cjAudio");
const cjWord = document.getElementById("cjWord");
const cjWordHint = document.getElementById("cjWordHint");

let cjList = [];
let cjIdx = 0;
let cjCarrier = null; // store the currently shown carrier word

function cjFilteredList() {
  if (!CONJ_READY) return [];
  const m = cjModule.value;
  if (m === "ALL") return CONJ.slice();
  return CONJ.filter(x => x.module === m);
}

function pickCarrierWord(conjObj) {
  const w = conjObj.words || [];
  if (!w.length) return null;
  return w[Math.floor(Math.random() * w.length)];
}

function cjRender() {
  cjList = cjFilteredList();
  if (!cjList.length) {
    cjForm.textContent = "‚Äî";
    cjHint.textContent = "‚Äî";
    cjFormationBox.style.display = "none";
    cjFormation.textContent = "‚Äî";
    cjAudio.textContent = "‚Äî";
    cjWord.textContent = "‚Äî";
    cjWordHint.textContent = "‚Äî";
    cjStatus.textContent = "No conjuncts (check module or JSON)";
    cjCarrier = null;
    return;
  }
  if (cjIdx < 0) cjIdx = cjList.length - 1;
  if (cjIdx >= cjList.length) cjIdx = 0;

  const x = cjList[cjIdx];
  cjForm.textContent = x.form || "‚Äî";
  cjHint.textContent = x.hint || "‚Äî";

  if (x.formation && x.formation.length === 2 && x.module === "A") {
    cjFormationBox.style.display = "block";
    cjFormation.textContent = `${x.formation[0]}  +  ${x.formation[1]}  ‚Üí  ${x.form}`;
  } else {
    cjFormationBox.style.display = "none";
  }

  // ‚úÖ Pick the carrier word ONCE and store it globally
  cjCarrier = pickCarrierWord(x);

  // ‚úÖ Display the carrier word (if any)
  if (cjCarrier) {
    cjWord.textContent = cjCarrier.word;
    cjWordHint.textContent = cjCarrier.hint || "‚Äî";
  } else {
    cjWord.textContent = "(no words yet)";
    cjWordHint.textContent = "‚Äî";
  }

  // ‚úÖ Show the ACTUAL audio path that Play will use
  if (x.audio) {
    cjAudio.textContent = x.audio;
  } else if (cjCarrier && cjCarrier.file) {
    cjAudio.textContent = cjCarrier.file;
  } else {
    cjAudio.textContent = "(no audio)";
  }

  cjStatus.textContent = `Item ${cjIdx + 1} / ${cjList.length}`;
}


function cjPlayNow() {
  if (!cjList.length) return;
  const x = cjList[cjIdx];

  // Prefer isolated conjunct audio if present
  if (x.audio) {
    playFile(x.audio, x.form);
    return;
  }

  // Otherwise play the SAME carrier word shown on screen
  if (cjCarrier && cjCarrier.file) {
    playFile(cjCarrier.file, cjCarrier.word);
  }
}


cjModule.addEventListener("change", () => { cjIdx = 0; cjRender(); });
cjPrev.addEventListener("click", () => { cjIdx--; cjRender(); });
cjNext.addEventListener("click", () => { cjIdx++; cjRender(); });
cjPlay.addEventListener("click", cjPlayNow);

// ---- Quiz (Hear‚ÜíChoose / Read‚ÜíChoose) ----
const cqModeRadios = document.querySelectorAll('input[name="cqMode"]');
const cqPlay = document.getElementById("cqPlay");
const cqNext = document.getElementById("cqNext");
const cqReset = document.getElementById("cqReset");
const cqResult = document.getElementById("cqResult");
const cqScore = document.getElementById("cqScore");
const cqPrompt = document.getElementById("cqPrompt");
const cqChoices = document.getElementById("cqChoices");

let cqMode = "hear";
let cqCorrect = 0, cqIncorrect = 0, cqStreak = 0, cqBest = 0;
let cqAnswer = null;
let cqOptions = [];
let cqLocked = false;

function cqSetResult(msg, kind="neutral") {
  cqResult.textContent = msg;
  cqResult.classList.remove("okPill","badPill");
  if (kind === "ok") cqResult.classList.add("okPill");
  if (kind === "bad") cqResult.classList.add("badPill");
}

function cqUpdateScore() {
  cqScore.textContent = `‚úÖ ${cqCorrect}  ‚ùå ${cqIncorrect}  üî• ${cqStreak} (best ${cqBest})`;
}

function shuffle(a) {
  for (let i=a.length-1; i>0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function conjPoolForQuiz() {
  // match the browse module selector to keep learning focused
  if (!CONJ_READY) return [];
  const m = cjModule.value;
  const pool = (m === "ALL") ? CONJ : CONJ.filter(x => x.module === m);
  return pool.filter(x => x && x.form);
}

function cqRenderChoices() {
  cqChoices.innerHTML = "";
  cqOptions.forEach(opt => {
    const b = document.createElement("button");
    b.className = "letterBtn choiceBtn";
    b.textContent = opt.form;
    b.title = opt.hint || "";
    b.onclick = () => cqChoose(opt, b);
    cqChoices.appendChild(b);
  });
}

function cqNewQuestion() {
  const pool = conjPoolForQuiz();
  if (!pool.length) {
    cqSetResult("No conjuncts available.", "bad");
    cqPrompt.textContent = "‚Äî";
    cqChoices.innerHTML = "";
    cqAnswer = null;
    return;
  }
  cqLocked = false;
  cqSetResult("Choose the correct conjunct", "neutral");

  cqAnswer = pool[Math.floor(Math.random()*pool.length)];

  const distractors = [];
  const seen = new Set([cqAnswer.id]);
  while (distractors.length < 3 && seen.size < pool.length) {
    const d = pool[Math.floor(Math.random()*pool.length)];
    if (!seen.has(d.id)) {
      seen.add(d.id);
      distractors.push(d);
    }
  }
  cqOptions = shuffle([cqAnswer, ...distractors]);

  cqPrompt.textContent = (cqMode === "hear") ? "üîä Listen" : (cqAnswer.hint || "(hint missing)");
  cqRenderChoices();

  if (cqMode === "hear") cqPlayNowQuiz();
}

function cqPlayNowQuiz() {
  if (!cqAnswer) return;

  // Use isolated conjunct audio if present else carrier word audio
  if (cqAnswer.audio) {
    playFile(cqAnswer.audio, cqAnswer.form);
    return;
  }
  const cw = pickCarrierWord(cqAnswer);
  if (cw && cw.file) playFile(cw.file, cw.word);
}

function cqChoose(opt, btn) {
  if (!cqAnswer || cqLocked) return;

  // clear styles
  cqChoices.querySelectorAll("button").forEach(b => b.classList.remove("correct","wrong"));

  if (opt.id === cqAnswer.id) {
    btn.classList.add("correct");
    cqSetResult("‚úÖ Correct", "ok");
    cqCorrect++; cqStreak++; if (cqStreak > cqBest) cqBest = cqStreak;
    cqUpdateScore();
    cqLocked = true;
    setTimeout(cqNewQuestion, 650);
  } else {
    btn.classList.add("wrong");
    cqSetResult("‚ùå Try again", "bad");
    cqIncorrect++; cqStreak = 0;
    cqUpdateScore();
    if (cqMode === "hear") setTimeout(cqPlayNowQuiz, 250);
  }
}

function cqResetAll() {
  cqCorrect = 0; cqIncorrect = 0; cqStreak = 0; cqBest = 0;
  cqUpdateScore();
  cqSetResult("Ready", "neutral");
  cqPrompt.textContent = "‚Äî";
  cqChoices.innerHTML = "";
  cqAnswer = null;
}

cqModeRadios.forEach(r => r.addEventListener("change", () => {
  cqMode = document.querySelector('input[name="cqMode"]:checked').value;
  cqNewQuestion();
}));

cqPlay.addEventListener("click", () => {
  if (!cqAnswer) cqNewQuestion();   // start quiz if nothing yet
  else cqPlayNowQuiz();             // otherwise replay audio
});
cqNext.addEventListener("click", cqNewQuestion);
cqReset.addEventListener("click", cqResetAll);

// Boot
(async function bootConjuncts(){
  await loadConjunctsJson();
  cjIdx = 0;
  cjRender();
  cqUpdateScore();
  // Do not auto-start the quiz on load
  cqSetResult("Ready ‚Äî click Next (play) to begin.", "neutral");
})();
</script>
</body>
</html>
