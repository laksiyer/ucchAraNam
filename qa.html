<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Devanagari Pronunciation Tool — QA</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffffff;
      --text:#111;
      --muted:#666;
      --border:#e6e6e6;
      --shadow:0 1px 2px rgba(0,0,0,.06);
      --accentBg:#f5f7ff;
      --accentBorder:#cbd5ff;
      --okBg:#d4f8d4; --okBd:#2f9e44;
      --badBg:#ffd6d6; --badBd:#c92a2a;
      --warnBg:#fff3bf; --warnBd:#f08c00;
    }

    body{
      font-family: system-ui, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 16px;
      max-width: 980px;
      margin: 0 auto;
    }
    h1{ font-size: 20px; margin: 0 0 10px; }
    h2{ font-size: 16px; margin: 0 0 10px; }

    .small{ font-size: 13px; color: var(--muted); }
    .pill{
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background:#fafafa;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .okPill { background: var(--okBg); border-color: var(--okBd); }
    .badPill{ background: var(--badBg); border-color: var(--badBd); }
    .warnPill{ background: var(--warnBg); border-color: var(--warnBd); }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin: 10px 0 12px;
    }

    .card{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: var(--shadow);
      background:#fff;
      box-sizing: border-box;
    }
    .cardAccent{
      background: var(--accentBg);
      border-color: var(--accentBorder);
    }

    label{ font-size: 14px; color:#333; }
    select, textarea, input[type="text"]{
      font-size: 14px;
      padding: 8px 10px;
      border-radius: 10px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
    }
    select:focus, textarea:focus, input[type="text"]:focus{
      border-color:#b9c2ff;
      box-shadow: 0 0 0 3px rgba(185,194,255,.35);
    }

    button{
      font-size: 15px;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      box-shadow: var(--shadow);
      user-select:none;
    }
    button:active{ transform: scale(0.98); }
    button.primary{ border-color:#b9c2ff; background:#f6f7ff; }
    button.good{ border-color: var(--okBd); background: var(--okBg); }
    button.bad{ border-color: var(--badBd); background: var(--badBg); }
    button.ghost{ background: transparent; box-shadow:none; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 720px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .bigGlyph{
      font-family: "Noto Sans Devanagari", system-ui, Arial, sans-serif;
      font-size: 54px;
      line-height: 1.1;
      margin: 0;
      word-break: break-word;
    }

    .metaLine{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 6px;
    }
    code.kv{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fbfbfb;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      padding: 2px 6px;
      border:1px solid var(--border);
      background:#fff;
      border-bottom-width:2px;
      border-radius: 6px;
    }

    textarea{ width: 100%; min-height: 70px; resize: vertical; }

    .mutedBox{
      border:1px dashed var(--border);
      border-radius: 12px;
      padding: 10px;
      background: rgba(255,255,255,.6);
    }

    .dangerNote{
      margin-top: 8px;
      font-size: 13px;
      color: #7a2e2e;
    }
  </style>
</head>

<body>
  <h1>QA — Recording Review</h1>

  <div class="card cardAccent">
    <div class="row" style="margin-top:0;">
      <span class="pill" id="qaStatus">Loading…</span>
      <span class="pill" id="qaCounts">—</span>
      <span class="pill" id="qaProgress">—</span>
    </div>

    <p class="small" style="margin:0 0 10px;">
      <b>How to use:</b> Choose a dataset (or keep <b>ALL</b>), then press <b>Next (Play)</b>.
      Approve/Reject, add a note if needed, keep going.
      <span class="small">(Shortcuts: <span class="kbd">N</span> next, <span class="kbd">P</span> play, <span class="kbd">A</span> approve, <span class="kbd">R</span> reject)</span>
    </p>

    <div class="row">
      <label>
        Dataset:
        <select id="qaDataset">
          <option value="all" selected>ALL (everything)</option>
          <option value="vowels">Vowels (स्वराः)</option>
          <option value="vargiya">Vargīya consonants (वर्गीय)</option>
          <option value="avargiya">Avargīya consonants (अवर्गीय)</option>
          <option value="gunita">Guṇitākṣarāṇi (generated)</option>
          <option value="gunita_words">Guṇita full words (words.json)</option>
          <option value="conj_words">Saṃyukta full words (conj/conjunct_words.json)</option>
          <option value="conj_items">Saṃyukta audios (conj/conjuncts.json)</option>
        </select>
      </label>

      <label>
        Filter:
        <select id="qaFilter">
          <option value="all" selected>All</option>
          <option value="unreviewed">Unreviewed</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
      </label>

      <label>
        Level:
        <select id="qaLevel">
          <option value="all" selected>All</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
        </select>
      </label>

      <label id="qaModuleWrap" style="display:none;">
        Module:
        <select id="qaModule">
          <option value="ALL" selected>All</option>
          <option value="A">A</option><option value="B">B</option><option value="C">C</option>
          <option value="D">D</option><option value="E">E</option><option value="F">F</option><option value="G">G</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label>
        Audio base:
        <select id="qaAudioBase">
          <option value="auto" selected>Auto (local on localhost, GitHub on github.io)</option>
          <option value="local">Local: ./audio/</option>
          <option value="github">GitHub: https://laksiyer.github.io/ucchAraNam/audio/</option>
          <option value="custom">Custom…</option>
        </select>
      </label>
      <input id="qaAudioCustom" type="text" placeholder="https://.../audio/" style="display:none; min-width:280px;" />
      <span class="small">(must end with /)</span>
    </div>

    <div class="row">
      <button id="qaPrev" class="ghost">Prev</button>
      <button id="qaNext" class="primary">Next (Play)</button>
      <button id="qaPlay">Play</button>
      <button id="qaApprove" class="good">Approve</button>
      <button id="qaReject" class="bad">Reject</button>
      <button id="qaClearDecision">Clear decision</button>
      <button id="qaResetAll" class="ghost" title="Clears ALL saved QA decisions for this tool">Reset QA data</button>
    </div>

    <div class="row">
      <button id="qaExportReviewed" class="primary">Export REVIEWED (all datasets)</button>
      <button id="qaExportAll">Export ALL items (with decisions)</button>
      <span class="small">TSV export (reviewer can email it to you).</span>
    </div>

    <div class="small mutedBox" id="dsHelp" style="margin-top:10px; display:none;">
      <b>Gunita note:</b> generated filenames are <code>stem_key.mp3</code> like
      <code>ka_a.mp3</code>, <code>tta_ii.mp3</code>, etc. If your naming differs, edit <code>GUNITA_STEMS</code>.
    </div>

    <div class="small mutedBox" id="loadWarn" style="margin-top:10px; display:none;">
      <b>Important:</b> This page must be served over HTTP (not opened as a file). Use:
      <code>python3 -m http.server 8000</code> then open <code>http://localhost:8000/qa.html</code>.
    </div>
  </div>

  <div class="grid2" style="margin-top:14px;">
    <div class="card">
      <h2 style="margin-top:0;">Current item</h2>
      <p class="bigGlyph" id="qaGlyph">—</p>

      <div class="metaLine">
        <code class="kv" id="qaHint">hint: —</code>
        <code class="kv" id="qaId">id: —</code>
        <code class="kv" id="qaSourceTag">source: —</code>
        <code class="kv" id="qaModuleTag" style="display:none;">module: —</code>
        <code class="kv" id="qaLevelTag">level: —</code>
      </div>

      <div class="metaLine" style="margin-top:10px;">
        <span class="pill" id="qaDecision">Decision: —</span>
        <span class="pill" id="qaAudioFile">Audio: —</span>
      </div>

      <div class="dangerNote" id="qaMissingNote" style="display:none;">
        This item has a blank audio path (or mismatch). Fix filename or upload later.
      </div>

      <div style="margin-top:12px;">
        <div class="small" style="margin-bottom:6px;"><b>Reviewer note</b> (optional)</div>
        <textarea id="qaNote" placeholder="e.g., vowel length off, aspiration weak, noise, clipped…"></textarea>
        <div class="row" style="margin:10px 0 0;">
          <button id="qaSaveNote">Save note</button>
        </div>
        <div class="small mutedBox" style="margin-top:10px;">
          Saved locally in the reviewer’s browser. Export TSV to share with you.
        </div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin-top:0;">Quick rubric</h2>
      <ul class="small" style="margin-top:0; padding-left:18px;">
        <li><b>Correct phoneme:</b> retroflex vs dental, ś/ṣ/s, aspiration, anusvāra/visarga.</li>
        <li><b>Vowel length:</b> a/ā, i/ī, u/ū, ṛ/ṝ.</li>
        <li><b>Clarity:</b> no clipping, consistent loudness, low noise.</li>
        <li><b>Timing:</b> not cut off at start/end.</li>
      </ul>

      <h2>Files expected</h2>
      <div class="small mutedBox">
        <div><b>Guṇita words:</b> <code>words.json</code></div>
        <div><b>Saṃyukta words:</b> <code>conj/conjunct_words.json</code></div>
        <div><b>Saṃyukta audios:</b> <code>conj/conjuncts.json</code></div>
      </div>

      <p class="small" style="margin-top:10px;">
        If audio won’t play, set <b>Audio base</b> correctly (Auto/Local/GitHub).
      </p>
    </div>
  </div>

  <script>
    // ============================================================
    // AUDIO BASE (matches your earlier QA links)
    // ============================================================
    const GITHUB_AUDIO = "https://laksiyer.github.io/ucchAraNam/audio/"; // must end with /

    function isGithubHost(){ return (location.hostname || "").includes("github.io"); }
    function isLocalHost(){
      const h = (location.hostname || "").toLowerCase();
      return h === "localhost" || h === "127.0.0.1" || h === "";
    }
    function getAudioBase(){
      const mode = qaAudioBase.value;
      if (mode === "github") return GITHUB_AUDIO;
      if (mode === "local") return "./audio/";
      if (mode === "custom") return (qaAudioCustom.value || "").trim();
      // auto:
      return isGithubHost() ? GITHUB_AUDIO : "./audio/";
    }
    function joinAudioUrl(file){
      if (!file) return "";
      if (/^https?:\/\//i.test(file)) return file;
      const base = getAudioBase();
      const b = base.endsWith("/") ? base : (base + "/");
      return b + String(file).replace(/^\/+/, "");
    }

    // ============================================================
    // BUILT-IN DATASETS (edit filenames ONLY if yours differ)
    // ============================================================
    const QA_VOWELS = [
      { id:"v_a",  glyph:"अ",  hint:"a",   level:1, file:"a.mp3" },
      { id:"v_aa", glyph:"आ",  hint:"ā",   level:1, file:"aa.mp3" },
      { id:"v_i",  glyph:"इ",  hint:"i",   level:1, file:"i.mp3" },
      { id:"v_ii", glyph:"ई",  hint:"ī",   level:1, file:"ii.mp3" },
      { id:"v_u",  glyph:"उ",  hint:"u",   level:1, file:"u.mp3" },
      { id:"v_uu", glyph:"ऊ",  hint:"ū",   level:1, file:"uu.mp3" },
      { id:"v_ri", glyph:"ऋ",  hint:"ṛ",   level:2, file:"ri.mp3" },
      { id:"v_rri",glyph:"ॠ",  hint:"ṝ",   level:3, file:"rri.mp3" },
      { id:"v_e",  glyph:"ए",  hint:"e",   level:1, file:"e.mp3" },
      { id:"v_ai", glyph:"ऐ",  hint:"ai",  level:2, file:"ai.mp3" },
      { id:"v_o",  glyph:"ओ",  hint:"o",   level:1, file:"o.mp3" },
      { id:"v_au", glyph:"औ",  hint:"au",  level:2, file:"au.mp3" },
      { id:"v_am", glyph:"अं", hint:"aṃ",  level:2, file:"am.mp3" },
      { id:"v_ah", glyph:"अः", hint:"aḥ",  level:2, file:"ah.mp3" }
    ];

    const QA_VARGIYA = [
      { id:"c_ka", glyph:"क", hint:"ka", level:1, file:"ka.mp3" },
      { id:"c_kha",glyph:"ख", hint:"kha",level:1, file:"kha.mp3" },
      { id:"c_ga", glyph:"ग", hint:"ga", level:1, file:"ga.mp3" },
      { id:"c_gha",glyph:"घ", hint:"gha",level:2, file:"gha.mp3" },
      { id:"c_nga",glyph:"ङ", hint:"ṅa", level:2, file:"nga.mp3" },

      { id:"c_ca", glyph:"च", hint:"ca", level:1, file:"ca.mp3" },
      { id:"c_cha",glyph:"छ", hint:"cha",level:1, file:"cha.mp3" },
      { id:"c_ja", glyph:"ज", hint:"ja", level:1, file:"ja.mp3" },
      { id:"c_jha",glyph:"झ", hint:"jha",level:2, file:"jha.mp3" },
      { id:"c_nya",glyph:"ञ", hint:"ña", level:2, file:"nya.mp3" },

      // If your base retroflex filenames differ, edit here:
      { id:"c_tta", glyph:"ट", hint:"ṭa",  level:2, file:"ta_retro.mp3" },
      { id:"c_ttha",glyph:"ठ", hint:"ṭha", level:2, file:"tha_retro.mp3" },
      { id:"c_dda", glyph:"ड", hint:"ḍa",  level:2, file:"da_retro.mp3" },
      { id:"c_ddha",glyph:"ढ", hint:"ḍha", level:3, file:"dha_retro.mp3" },
      { id:"c_nna", glyph:"ण", hint:"ṇa",  level:2, file:"na_retro.mp3" },

      { id:"c_ta",  glyph:"त", hint:"ta",  level:1, file:"ta.mp3" },
      { id:"c_tha", glyph:"थ", hint:"tha", level:1, file:"tha.mp3" },
      { id:"c_da",  glyph:"द", hint:"da",  level:1, file:"da.mp3" },
      { id:"c_dha", glyph:"ध", hint:"dha", level:2, file:"dha.mp3" },
      { id:"c_na",  glyph:"न", hint:"na",  level:1, file:"na.mp3" },

      { id:"c_pa",  glyph:"प", hint:"pa",  level:1, file:"pa.mp3" },
      { id:"c_pha", glyph:"फ", hint:"pha", level:2, file:"pha.mp3" },
      { id:"c_ba",  glyph:"ब", hint:"ba",  level:1, file:"ba.mp3" },
      { id:"c_bha", glyph:"भ", hint:"bha", level:2, file:"bha.mp3" },
      { id:"c_ma",  glyph:"म", hint:"ma",  level:1, file:"ma.mp3" }
    ];

    const QA_AVARGIYA = [
      { id:"a_ya", glyph:"य", hint:"ya", level:1, file:"ya.mp3" },
      { id:"a_ra", glyph:"र", hint:"ra", level:1, file:"ra.mp3" },
      { id:"a_la", glyph:"ल", hint:"la", level:1, file:"la.mp3" },
      { id:"a_va", glyph:"व", hint:"va", level:1, file:"va.mp3" },
      { id:"a_sha",glyph:"श", hint:"śa", level:2, file:"sha_palatal.mp3" },
      { id:"a_ssa",glyph:"ष", hint:"ṣa", level:2, file:"sha_retro.mp3" },
      { id:"a_sa", glyph:"स", hint:"sa", level:1, file:"sa.mp3" },
      { id:"a_ha", glyph:"ह", hint:"ha", level:1, file:"ha.mp3" }
    ];

    // ============================================================
    // GUNITA (generated): stem_key.mp3
    // ============================================================
    const GUNITA_VOWELS = [
      { key:"a",  label:"अ",  hint:"a"  },
      { key:"aa", label:"आ",  hint:"ā"  },
      { key:"i",  label:"इ",  hint:"i"  },
      { key:"ii", label:"ई",  hint:"ī"  },
      { key:"u",  label:"उ",  hint:"u"  },
      { key:"uu", label:"ऊ",  hint:"ū"  },
      { key:"ri", label:"ऋ",  hint:"ṛ"  },
      { key:"rri",label:"ॠ",  hint:"ṝ"  },
      { key:"e",  label:"ए",  hint:"e"  },
      { key:"ai", label:"ऐ",  hint:"ai" },
      { key:"o",  label:"ओ",  hint:"o"  },
      { key:"au", label:"औ",  hint:"au" },
      { key:"am", label:"अं", hint:"aṃ" },
      { key:"ah", label:"अः", hint:"aḥ" }
    ];

    // This must match your naming: stem_key.mp3 (ka_a.mp3 etc.)
    const GUNITA_STEMS = [
      { id:"g_ka",  glyph:"क", hint:"ka",  level:1, stem:"ka" },
      { id:"g_kha", glyph:"ख", hint:"kha", level:1, stem:"kha" },
      { id:"g_ga",  glyph:"ग", hint:"ga",  level:1, stem:"ga" },
      { id:"g_gha", glyph:"घ", hint:"gha", level:2, stem:"gha" },
      { id:"g_nga", glyph:"ङ", hint:"ṅa",  level:2, stem:"nga" },

      { id:"g_ca",  glyph:"च", hint:"ca",  level:1, stem:"ca" },
      { id:"g_cha", glyph:"छ", hint:"cha", level:1, stem:"cha" },
      { id:"g_ja",  glyph:"ज", hint:"ja",  level:1, stem:"ja" },
      { id:"g_jha", glyph:"झ", hint:"jha", level:2, stem:"jha" },
      { id:"g_nya", glyph:"ञ", hint:"ña",  level:2, stem:"nya" },

      { id:"g_tta",  glyph:"ट", hint:"ṭa",  level:2, stem:"tta" },
      { id:"g_ttha", glyph:"ठ", hint:"ṭha", level:2, stem:"ttha" },
      { id:"g_dda",  glyph:"ड", hint:"ḍa",  level:2, stem:"dda" },
      { id:"g_ddha", glyph:"ढ", hint:"ḍha", level:3, stem:"ddha" },
      { id:"g_nna",  glyph:"ण", hint:"ṇa",  level:2, stem:"nna" },

      { id:"g_ta",  glyph:"त", hint:"ta",  level:1, stem:"ta" },
      { id:"g_tha", glyph:"थ", hint:"tha", level:1, stem:"tha" },
      { id:"g_da",  glyph:"द", hint:"da",  level:1, stem:"da" },
      { id:"g_dha", glyph:"ध", hint:"dha", level:2, stem:"dha" },
      { id:"g_na",  glyph:"न", hint:"na",  level:1, stem:"na" },

      { id:"g_pa",  glyph:"प", hint:"pa",  level:1, stem:"pa" },
      { id:"g_pha", glyph:"फ", hint:"pha", level:2, stem:"pha" },
      { id:"g_ba",  glyph:"ब", hint:"ba",  level:1, stem:"ba" },
      { id:"g_bha", glyph:"भ", hint:"bha", level:2, stem:"bha" },
      { id:"g_ma",  glyph:"म", hint:"ma",  level:1, stem:"ma" },

      { id:"g_ya", glyph:"य", hint:"ya", level:1, stem:"ya" },
      { id:"g_ra", glyph:"र", hint:"ra", level:1, stem:"ra" },
      { id:"g_la", glyph:"ल", hint:"la", level:1, stem:"la" },
      { id:"g_va", glyph:"व", hint:"va", level:1, stem:"va" },
      { id:"g_sa", glyph:"स", hint:"sa", level:1, stem:"sa" },
      { id:"g_ha", glyph:"ह", hint:"ha", level:1, stem:"ha" }
    ];

    // ============================================================
    // JSON datasets (your links)
    // ============================================================
    // gunita words:  words.json
    // samyuta words: conj/conjunct_words.json
    // samyuta items: conj/conjuncts.json
    let WORDS = [], WORDS_READY = false;
    let CONJ_WORDS = [], CONJ_WORDS_READY = false;
    let CONJ = [], CONJ_READY = false;

    async function fetchJson(path){
      const res = await fetch(path + "?v=" + Date.now());
      if (!res.ok) throw new Error("HTTP " + res.status + " for " + path);
      return await res.json();
    }

    // ============================================================
    // UI refs
    // ============================================================
    const qaStatus = document.getElementById("qaStatus");
    const qaCounts = document.getElementById("qaCounts");
    const qaProgress = document.getElementById("qaProgress");

    const qaDataset = document.getElementById("qaDataset");
    const qaFilter = document.getElementById("qaFilter");
    const qaLevel = document.getElementById("qaLevel");
    const qaModuleWrap = document.getElementById("qaModuleWrap");
    const qaModule = document.getElementById("qaModule");
    const dsHelp = document.getElementById("dsHelp");
    const loadWarn = document.getElementById("loadWarn");

    const qaAudioBase = document.getElementById("qaAudioBase");
    const qaAudioCustom = document.getElementById("qaAudioCustom");

    const qaPrev = document.getElementById("qaPrev");
    const qaNext = document.getElementById("qaNext");
    const qaPlay = document.getElementById("qaPlay");
    const qaApprove = document.getElementById("qaApprove");
    const qaReject = document.getElementById("qaReject");
    const qaClearDecision = document.getElementById("qaClearDecision");
    const qaResetAll = document.getElementById("qaResetAll");

    const qaExportReviewed = document.getElementById("qaExportReviewed");
    const qaExportAll = document.getElementById("qaExportAll");

    const qaGlyph = document.getElementById("qaGlyph");
    const qaHint = document.getElementById("qaHint");
    const qaId = document.getElementById("qaId");
    const qaSourceTag = document.getElementById("qaSourceTag");
    const qaModuleTag = document.getElementById("qaModuleTag");
    const qaLevelTag = document.getElementById("qaLevelTag");
    const qaDecision = document.getElementById("qaDecision");
    const qaAudioFile = document.getElementById("qaAudioFile");
    const qaMissingNote = document.getElementById("qaMissingNote");

    const qaNote = document.getElementById("qaNote");
    const qaSaveNote = document.getElementById("qaSaveNote");

    // ============================================================
    // Audio player
    // ============================================================
    const player = new Audio();
    player.preload = "auto";

    function setStatus(msg, kind="neutral"){
      qaStatus.textContent = msg;
      qaStatus.classList.remove("okPill","badPill","warnPill");
      if (kind==="ok") qaStatus.classList.add("okPill");
      if (kind==="bad") qaStatus.classList.add("badPill");
      if (kind==="warn") qaStatus.classList.add("warnPill");
    }

    function playFile(file){
      if (!file) { setStatus("No audio for this item", "warn"); return; }
      const url = joinAudioUrl(file);
      try { player.pause(); player.currentTime = 0; } catch(e){}
      player.src = url;
      setStatus("Loading…", "neutral");
      player.play()
        .then(()=> setStatus("Playing", "ok"))
        .catch(()=> setStatus("Could not play: " + url, "bad"));
    }

    // ============================================================
    // QA storage (shared across ALL datasets)
    // ============================================================
    const LS_KEY = "uccharanam_qa_v3_full";

    function loadStore(){
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }
      catch(e){ return {}; }
    }
    function saveStore(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }
    function getEntry(key){ const st = loadStore(); return st[key] || null; }
    function setEntry(key, patch){
      const st = loadStore();
      st[key] = { ...(st[key]||{}), ...patch, t: Date.now() };
      saveStore(st);
    }
    function clearEntry(key){
      const st = loadStore();
      delete st[key];
      saveStore(st);
    }
    function resetStore(){ localStorage.removeItem(LS_KEY); }

    // ============================================================
    // Build unified master list
    // item model: { key, ds, id, glyph, hint, level, module, file }
    // ============================================================
    function buildGunitaItems(){
      const out = [];
      for (const c of GUNITA_STEMS){
        for (const v of GUNITA_VOWELS){
          const file = `${c.stem}_${v.key}.mp3`;
          const glyph = `${c.glyph} + ${v.label}`;
          const hint = `${c.hint} + ${v.hint}`;
          const id = `${c.id}_${v.key}`;
          out.push({
            key: `gunita:${id}:${file}`,
            ds: "gunita",
            id, glyph, hint,
            level: c.level ?? "",
            module: "",
            file
          });
        }
      }
      return out;
    }

    function conjIdToModuleMap(){
      const m = new Map();
      if (Array.isArray(CONJ)) CONJ.forEach(x => { if (x && x.id) m.set(x.id, x.module || ""); });
      return m;
    }

    function normalizeWordObj(w){
      // Your JSON might use file OR audio. Accept both.
      const file = (w.file || w.audio || w.mp3 || "").toString();
      const word = (w.word || w.form || w.glyph || "").toString();
      const id = (w.id || w.word || w.form || "").toString();
      const hint = (w.hint || w.roman || w.translit || "").toString();
      const level = (w.level ?? "").toString();
      return { id, word, hint, level, file };
    }

    function buildMasterAllItems(){
      const items = [];

      QA_VOWELS.forEach(x=>items.push({
        key:`vowels:${x.id}:${x.file}`, ds:"vowels", id:x.id, glyph:x.glyph, hint:x.hint, level:x.level??"", module:"", file:x.file
      }));
      QA_VARGIYA.forEach(x=>items.push({
        key:`vargiya:${x.id}:${x.file}`, ds:"vargiya", id:x.id, glyph:x.glyph, hint:x.hint, level:x.level??"", module:"", file:x.file
      }));
      QA_AVARGIYA.forEach(x=>items.push({
        key:`avargiya:${x.id}:${x.file}`, ds:"avargiya", id:x.id, glyph:x.glyph, hint:x.hint, level:x.level??"", module:"", file:x.file
      }));

      buildGunitaItems().forEach(it=>items.push(it));

      // ----------------------------------------------------------
      // ALL guṇita words from words.json
      // ----------------------------------------------------------
      if (WORDS_READY) {
        WORDS.forEach(w=>{
          const nw = normalizeWordObj(w);
          const key = `gunita_words:${nw.id}:${nw.file}`;
          items.push({
            key,
            ds: "gunita_words",
            id: nw.id,
            glyph: nw.word,
            hint: nw.hint,
            level: nw.level,
            module: "",
            file: nw.file
          });
        });
      }

      // ----------------------------------------------------------
      // ALL saṃyukta words from conj/conjunct_words.json
      // ----------------------------------------------------------
      if (CONJ_WORDS_READY) {
        const idToMod = conjIdToModuleMap();
        CONJ_WORDS.forEach(w=>{
          // expected schema in your earlier QA: conj_id, word, hint, level, file, idx
          const cid = (w.conj_id || w.id || "").toString();
          const word = (w.word || w.form || "").toString();
          const hint = (w.hint || w.roman || "").toString();
          const level = (w.level ?? "").toString();
          const file = (w.file || w.audio || "").toString();
          const mod = idToMod.get(cid) || (w.module || "");
          const idx = (w.idx ?? "").toString();
          const key = `conj_words:${cid}:${idx}:${file}`;
          items.push({
            key,
            ds: "conj_words",
            id: cid,
            glyph: word,
            hint,
            level,
            module: mod,
            file
          });
        });
      }

      // ----------------------------------------------------------
      // ALL saṃyukta items from conj/conjuncts.json
      // ----------------------------------------------------------
      if (CONJ_READY) {
        CONJ.forEach(x=>{
          const id = (x.id || "").toString();
          const glyph = (x.form || x.glyph || "").toString();
          const hint = (x.hint || "").toString();
          const mod = (x.module || "").toString();
          const file = (x.audio || x.file || "").toString();
          const key = `conj_items:${id}:${file}`;
          items.push({
            key,
            ds: "conj_items",
            id,
            glyph,
            hint,
            level: "",
            module: mod,
            file
          });
        });
      }

      return items.filter(x => x && x.glyph);
    }

    // ============================================================
    // Filtering + navigation list
    // ============================================================
    let MASTER = [];
    let VIEW = [];
    let idx = -1;

    function applyFilters(items){
      const ds = qaDataset.value;
      const f = qaFilter.value;
      const lvl = qaLevel.value;
      const mod = qaModule.value;

      return items.filter(it=>{
        if (ds !== "all" && it.ds !== ds) return false;

        const entry = getEntry(it.key);
        const decision = entry?.decision || "";

        if (f === "unreviewed" && decision) return false;
        if (f === "approved" && decision !== "approved") return false;
        if (f === "rejected" && decision !== "rejected") return false;

        if (lvl !== "all" && String(it.level ?? "") !== String(lvl)) return false;

        // module filter relevant for conjunct + all
        const needsModule = (ds === "conj_words" || ds === "conj_items" || ds === "all");
        if (needsModule && qaModuleWrap.style.display !== "none") {
          if (mod !== "ALL" && String(it.module || "") !== String(mod)) return false;
        }

        return true;
      });
    }

    function updateCounts(){
      const st = loadStore();
      const all = MASTER.length;
      let reviewed=0, approved=0, rejected=0;

      Object.values(st).forEach(v=>{
        if (!v) return;
        if (v.decision === "approved") { reviewed++; approved++; }
        else if (v.decision === "rejected") { reviewed++; rejected++; }
      });

      qaCounts.textContent = `Master: ${all} · Reviewed: ${reviewed} · ✅ ${approved} · ❌ ${rejected}`;
      qaProgress.textContent = (!VIEW.length) ? "0 / 0" : `${idx+1} / ${VIEW.length}`;
    }

    function currentItem(){ return (idx>=0 && idx<VIEW.length) ? VIEW[idx] : null; }

    function renderCurrent(){
      updateCounts();
      const it = currentItem();

      if (!it){
        qaGlyph.textContent = "—";
        qaHint.textContent = "hint: —";
        qaId.textContent = "id: —";
        qaSourceTag.textContent = "source: —";
        qaModuleTag.style.display = "none";
        qaLevelTag.textContent = "level: —";
        qaDecision.textContent = "Decision: —";
        qaAudioFile.textContent = "Audio: —";
        qaMissingNote.style.display = "none";
        qaNote.value = "";
        setStatus("No items for this filter", "warn");
        return;
      }

      qaGlyph.textContent = it.glyph;
      qaHint.textContent = "hint: " + (it.hint || "—");
      qaId.textContent = "id: " + (it.id || "—");
      qaSourceTag.textContent = "source: " + it.ds;
      qaLevelTag.textContent = "level: " + (it.level === "" ? "—" : it.level);

      if (it.module) {
        qaModuleTag.style.display = "inline-block";
        qaModuleTag.textContent = "module: " + it.module;
      } else {
        qaModuleTag.style.display = "none";
      }

      qaAudioFile.textContent = "Audio: " + (it.file || "(blank)");
      qaMissingNote.style.display = (!it.file) ? "block" : "none";

      const entry = getEntry(it.key);
      const decision = entry?.decision || "";
      qaNote.value = entry?.note || "";

      if (!decision) qaDecision.textContent = "Decision: —";
      if (decision==="approved") qaDecision.textContent = "Decision: ✅ Approved";
      if (decision==="rejected") qaDecision.textContent = "Decision: ❌ Rejected";
    }

    function rebuildView(resetIndex=false){
      const ds = qaDataset.value;

      const needsModule = (ds === "conj_words" || ds === "conj_items" || ds === "all");
      qaModuleWrap.style.display = needsModule ? "inline-flex" : "none";

      dsHelp.style.display = (ds === "gunita") ? "block" : "none";

      VIEW = applyFilters(MASTER);
      if (resetIndex) idx = -1;
      if (idx >= VIEW.length) idx = VIEW.length - 1;

      renderCurrent();
    }

    // ============================================================
    // Actions
    // ============================================================
    function nextAndPlay(){
      if (!VIEW.length) { renderCurrent(); return; }
      idx++;
      if (idx >= VIEW.length) idx = 0;
      renderCurrent();
      playNow();
    }
    function prevOnly(){
      if (!VIEW.length) { renderCurrent(); return; }
      idx--;
      if (idx < 0) idx = VIEW.length - 1;
      renderCurrent();
    }
    function playNow(){
      const it = currentItem();
      if (!it) return;
      playFile(it.file);
    }
    function approveNow(){
      const it = currentItem();
      if (!it) return;
      setEntry(it.key, { decision: "approved" });
      setStatus("Approved", "ok");
      renderCurrent();
    }
    function rejectNow(){
      const it = currentItem();
      if (!it) return;
      setEntry(it.key, { decision: "rejected" });
      setStatus("Rejected", "bad");
      renderCurrent();
    }
    function clearDecisionNow(){
      const it = currentItem();
      if (!it) return;
      const entry = getEntry(it.key);
      if (entry?.note) setEntry(it.key, { decision: "" });
      else clearEntry(it.key);
      setStatus("Cleared decision", "neutral");
      renderCurrent();
    }
    function saveNoteNow(){
      const it = currentItem();
      if (!it) return;
      const note = (qaNote.value || "").trim();
      setEntry(it.key, { note });
      setStatus(note ? "Note saved" : "Note cleared", "ok");
      renderCurrent();
    }
    function resetEverything(){
      if (!confirm("This will delete ALL QA decisions/notes saved in this browser for this tool. Continue?")) return;
      resetStore();
      setStatus("QA data reset", "warn");
      renderCurrent();
    }

    function tsvEscape(s){
      s = (s ?? "").toString();
      return s.replace(/\t/g," ").replace(/\r?\n/g,"  ");
    }

    function downloadTSV(text, filename){
      const blob = new Blob([text], { type: "text/tab-separated-values;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Export ONLY reviewed entries across ALL datasets
    function exportReviewedTSV(){
      const st = loadStore();
      const rows = [];
      rows.push(["key","dataset","id","glyph","hint","level","module","file","decision","note","timestamp"].join("\t"));

      MASTER.forEach(it=>{
        const entry = st[it.key] || {};
        const decision = entry.decision || "";
        if (decision !== "approved" && decision !== "rejected") return;

        const note = entry.note || "";
        const ts = entry.t ? new Date(entry.t).toISOString() : "";
        rows.push([
          tsvEscape(it.key),
          tsvEscape(it.ds),
          tsvEscape(it.id),
          tsvEscape(it.glyph),
          tsvEscape(it.hint),
          tsvEscape(it.level),
          tsvEscape(it.module),
          tsvEscape(it.file),
          tsvEscape(decision),
          tsvEscape(note),
          tsvEscape(ts),
        ].join("\t"));
      });

      downloadTSV(rows.join("\n"), "qa_reviewed.tsv");
      setStatus("Exported qa_reviewed.tsv", "ok");
    }

    // Export ALL items with decisions
    function exportAllTSV(){
      const st = loadStore();
      const rows = [];
      rows.push(["key","dataset","id","glyph","hint","level","module","file","decision","note","timestamp"].join("\t"));

      MASTER.forEach(it=>{
        const entry = st[it.key] || {};
        const decision = entry.decision || "";
        const note = entry.note || "";
        const ts = entry.t ? new Date(entry.t).toISOString() : "";
        rows.push([
          tsvEscape(it.key),
          tsvEscape(it.ds),
          tsvEscape(it.id),
          tsvEscape(it.glyph),
          tsvEscape(it.hint),
          tsvEscape(it.level),
          tsvEscape(it.module),
          tsvEscape(it.file),
          tsvEscape(decision),
          tsvEscape(note),
          tsvEscape(ts),
        ].join("\t"));
      });

      downloadTSV(rows.join("\n"), "qa_all.tsv");
      setStatus("Exported qa_all.tsv", "ok");
    }

    // ============================================================
    // Boot: load JSONs then build MASTER
    // ============================================================
    async function loadAll(){
      // Warn if opened as file://
      if (location.protocol === "file:") {
        loadWarn.style.display = "block";
      }

      try{
        WORDS = await fetchJson("words.json");
        WORDS_READY = Array.isArray(WORDS);
      } catch(e){
        console.error(e);
        WORDS = []; WORDS_READY = false;
      }

      try{
        CONJ_WORDS = await fetchJson("conj/conjunct_words.json");
        CONJ_WORDS_READY = Array.isArray(CONJ_WORDS);
      } catch(e){
        console.error(e);
        CONJ_WORDS = []; CONJ_WORDS_READY = false;
      }

      try{
        CONJ = await fetchJson("conj/conjuncts.json");
        CONJ_READY = Array.isArray(CONJ);
      } catch(e){
        console.error(e);
        CONJ = []; CONJ_READY = false;
      }

      MASTER = buildMasterAllItems();
      rebuildView(true);

      // Provide a helpful status
      const parts = [];
      parts.push(`MASTER=${MASTER.length}`);
      parts.push(`words.json=${WORDS_READY ? WORDS.length : "FAILED"}`);
      parts.push(`conj_words=${CONJ_WORDS_READY ? CONJ_WORDS.length : "FAILED"}`);
      parts.push(`conj_items=${CONJ_READY ? CONJ.length : "FAILED"}`);

      setStatus("Ready — " + parts.join(" · ") + " — press Next (Play)", "ok");
    }

    // ============================================================
    // Wiring
    // ============================================================
    qaDataset.addEventListener("change", ()=> rebuildView(true));
    qaFilter.addEventListener("change", ()=> rebuildView(true));
    qaLevel.addEventListener("change", ()=> rebuildView(true));
    qaModule.addEventListener("change", ()=> rebuildView(true));

    qaAudioBase.addEventListener("change", ()=>{
      const v = qaAudioBase.value;
      qaAudioCustom.style.display = (v === "custom") ? "inline-block" : "none";
      setStatus("Audio base updated", "ok");
    });
    qaAudioCustom.addEventListener("change", ()=> setStatus("Custom audio base updated", "ok"));

    qaPrev.addEventListener("click", prevOnly);
    qaNext.addEventListener("click", nextAndPlay);
    qaPlay.addEventListener("click", playNow);
    qaApprove.addEventListener("click", approveNow);
    qaReject.addEventListener("click", rejectNow);
    qaClearDecision.addEventListener("click", clearDecisionNow);
    qaSaveNote.addEventListener("click", saveNoteNow);
    qaResetAll.addEventListener("click", resetEverything);

    qaExportReviewed.addEventListener("click", exportReviewedTSV);
    qaExportAll.addEventListener("click", exportAllTSV);

    document.addEventListener("keydown", (e)=>{
      const tag = (document.activeElement && document.activeElement.tagName) ? document.activeElement.tagName.toLowerCase() : "";
      if (tag === "textarea" || tag === "input" || tag === "select") return;

      const k = e.key.toLowerCase();
      if (k === "n") { e.preventDefault(); nextAndPlay(); }
      if (k === "p" || k === " ") { e.preventDefault(); playNow(); }
      if (k === "a") { e.preventDefault(); approveNow(); }
      if (k === "r") { e.preventDefault(); rejectNow(); }
    });

    // Boot
    setStatus("Loading datasets…", "warn");
    loadAll();
  </script>
</body>
</html>
