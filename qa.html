<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Devanagari Pronunciation Tool — QA</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600&display=swap" rel="stylesheet">

<style>
body{font-family:system-ui,Arial,sans-serif;max-width:980px;margin:0 auto;padding:16px}
h1{font-size:20px;margin:0 0 10px}
h2{font-size:16px;margin:0 0 10px}
.small{font-size:13px;color:#666}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0}
.card{border:1px solid #ddd;border-radius:14px;padding:14px;background:#fff}
.cardAccent{background:#f5f7ff;border-color:#cbd5ff}
.pill{font-size:13px;padding:6px 10px;border-radius:999px;border:1px solid #ddd;background:#fafafa}
.okPill{background:#d4f8d4;border-color:#2f9e44}
.badPill{background:#ffd6d6;border-color:#c92a2a}
.warnPill{background:#fff3bf;border-color:#f08c00}
button{font-size:14px;padding:8px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
button.primary{background:#eef2ff;border-color:#b9c2ff}
button.good{background:#d4f8d4;border-color:#2f9e44}
button.bad{background:#ffd6d6;border-color:#c92a2a}
.bigGlyph{font-family:"Noto Sans Devanagari";font-size:54px;margin:0}
code.kv{font-family:monospace;font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid #ddd;background:#fbfbfb}
textarea{width:100%;min-height:70px}
</style>
</head>

<body>
<h1>QA — Recording Review</h1>

<div class="card cardAccent">
  <div class="row">
    <span class="pill" id="qaStatus">Ready</span>
    <span class="pill" id="qaCounts">—</span>
    <span class="pill" id="qaProgress">—</span>
  </div>

  <div class="row">
    <label>Dataset:
      <select id="qaDataset">
        <option value="vowels">Vowels</option>
        <option value="vargiya">Vargiya</option>
        <option value="avargiya">Avargiya</option>
        <option value="gunita">Gunita</option>
        <option value="gunita_words">Gunita words</option>
        <option value="conj_words">Conjunct words</option>
        <option value="conj_items">Conjunct audios</option>
        <option value="custom_inline">Custom inline</option>
      </select>
    </label>

    <label>Filter:
      <select id="qaFilter">
        <option value="all">All</option>
        <option value="unreviewed">Unreviewed</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
      </select>
    </label>
  </div>

  <div class="row">
    <button id="qaPrev">Prev</button>
    <button id="qaNext" class="primary">Next (Play)</button>
    <button id="qaPlay">Play</button>
    <button id="qaApprove" class="good">Approve</button>
    <button id="qaReject" class="bad">Reject</button>
    <button id="qaExport" class="primary">Export TSV (ALL reviewed)</button>
  </div>
</div>

<div class="card" style="margin-top:14px">
  <h2>Current item</h2>
  <p class="bigGlyph" id="qaGlyph">—</p>

  <div class="row">
    <code class="kv" id="qaHint">hint: —</code>
    <code class="kv" id="qaId">id: —</code>
    <code class="kv" id="qaLevel">level: —</code>
  </div>

  <div class="row">
    <span class="pill" id="qaDecision">Decision: —</span>
    <span class="pill" id="qaAudio">Audio: —</span>
  </div>

  <textarea id="qaNote" placeholder="Reviewer note (optional)"></textarea>
</div>

<script>
const AUDIO_BASE_URL="https://laksiyer.github.io/ucchAraNam/audio/";
const LS_KEY="uccharanam_qa_v3";

/* ---------------- DATASETS ---------------- */

const QA_VOWELS=[
 {id:"v_a",glyph:"अ",hint:"a",level:1,file:"a.mp3"},
 {id:"v_aa",glyph:"आ",hint:"ā",level:1,file:"aa.mp3"}
];

const QA_VARGIYA=[
 {id:"c_ka",glyph:"क",hint:"ka",level:1,file:"ka.mp3"}
];

const QA_AVARGIYA=[
 {id:"a_ya",glyph:"य",hint:"ya",level:1,file:"ya.mp3"}
];

const GUNITA_STEMS=[{id:"g_ka",glyph:"क",hint:"ka",level:1,stem:"ka"}];
const GUNITA_VOWELS=[{key:"a",label:"अ",hint:"a"}];

const QA_INLINE=[];

/* ---------------- STORAGE ---------------- */

function loadStore(){return JSON.parse(localStorage.getItem(LS_KEY)||"{}")}
function saveStore(o){localStorage.setItem(LS_KEY,JSON.stringify(o))}
function setEntry(k,p){const s=loadStore();s[k]={...(s[k]||{}),...p,t:Date.now()};saveStore(s)}
function getEntry(k){return loadStore()[k]||{}}

/* ---------------- BUILD ITEMS ---------------- */

function buildGunita(){
 const out=[];
 for(const c of GUNITA_STEMS){
  for(const v of GUNITA_VOWELS){
   out.push({
    key:`gunita:${c.id}_${v.key}`,
    id:`${c.id}_${v.key}`,
    glyph:`${c.glyph}+${v.label}`,
    hint:`${c.hint}+${v.hint}`,
    level:c.level,
    file:`${c.stem}_${v.key}.mp3`,
    source:"gunita"
   });
  }
 }
 return out;
}

function buildAll(){
 const out=[];
 const add=(src,arr)=>arr.forEach(x=>out.push({...x,source:src}));
 add("vowels",QA_VOWELS.map(x=>({...x,key:`vowels:${x.id}`})));
 add("vargiya",QA_VARGIYA.map(x=>({...x,key:`vargiya:${x.id}`})));
 add("avargiya",QA_AVARGIYA.map(x=>({...x,key:`avargiya:${x.id}`})));
 buildGunita().forEach(x=>out.push(x));
 QA_INLINE.forEach(x=>out.push({...x,key:`inline:${x.id}`,source:"inline"}));
 return out;
}

let ALL_ITEMS=buildAll();
let LIST=[],IDX=-1;

/* ---------------- UI ---------------- */

const el=id=>document.getElementById(id);
const audio=new Audio();

function refresh(){
 const ds=el("qaDataset").value;
 const f=el("qaFilter").value;
 LIST=ALL_ITEMS.filter(it=>{
  if(ds!=="all" && !it.source.startsWith(ds)){}
  const d=getEntry(it.key).decision;
  if(f==="approved"&&d!=="approved")return false;
  if(f==="rejected"&&d!=="rejected")return false;
  if(f==="unreviewed"&&d)return false;
  return true;
 });
 if(IDX>=LIST.length)IDX=0;
 render();
}

function render(){
 el("qaCounts").textContent=`Reviewed: ${Object.keys(loadStore()).length}`;
 el("qaProgress").textContent=LIST.length?`${IDX+1}/${LIST.length}`:"0/0";
 const it=LIST[IDX];
 if(!it){el("qaGlyph").textContent="—";return;}
 el("qaGlyph").textContent=it.glyph;
 el("qaHint").textContent="hint: "+it.hint;
 el("qaId").textContent="id: "+it.id;
 el("qaLevel").textContent="level: "+(it.level||"—");
 el("qaAudio").textContent="Audio: "+it.file;
 const e=getEntry(it.key);
 el("qaDecision").textContent="Decision: "+(e.decision||"—");
 el("qaNote").value=e.note||"";
}

function play(){
 const it=LIST[IDX];if(!it)return;
 audio.src=AUDIO_BASE_URL+it.file;
 audio.play();
}

function decide(d){
 const it=LIST[IDX];if(!it)return;
 setEntry(it.key,{decision:d,note:el("qaNote").value});
 refresh();
}

function exportTSV(){
 const st=loadStore();
 const rows=["key\tsource\tid\tglyph\thint\tlevel\tfile\tdecision\tnote\ttime"];
 ALL_ITEMS.forEach(it=>{
  const e=st[it.key]; if(!e)return;
  rows.push([
   it.key,it.source,it.id,it.glyph,it.hint,it.level,it.file,
   e.decision||"",e.note||"",new Date(e.t).toISOString()
  ].join("\t"));
 });
 const blob=new Blob([rows.join("\n")],{type:"text/tab-separated-values"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="qa_export_ALL_reviewed.tsv";
 a.click();
}

el("qaNext").onclick=()=>{IDX=(IDX+1)%LIST.length;render();play()};
el("qaPrev").onclick=()=>{IDX=(IDX-1+LIST.length)%LIST.length;render()};
el("qaPlay").onclick=play;
el("qaApprove").onclick=()=>decide("approved");
el("qaReject").onclick=()=>decide("rejected");
el("qaExport").onclick=exportTSV;
el("qaDataset").onchange=()=>{IDX=0;refresh()};
el("qaFilter").onchange=()=>{IDX=0;refresh()};

refresh();
</script>
</body>
</html>
